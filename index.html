<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description"
        content="Le guide ultime pour voyager à Madagascar - Spots locaux authentiques, carte interactive offline, expressions malgaches">
    <meta name="theme-color" content="#C13535">
    <meta name="color-scheme" content="light dark">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>MG Guide Voyage Madagascar - Le guide que seuls les Malgaches connaissent</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" href="images/logo/favicon.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="shortcut icon" href="icons/favicon.ico">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&family=Outfit:wght@400;500;600;700;800&family=Roboto+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="styles-map.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="css/styles-premium.css">

    <style>
        /* ============================================
           VARIABLES CSS & RESET
           ============================================ */
        :root {
            /* Couleurs principales (identité malgache préservée) */
            --laterite: #b03030;
            /* Légèrement plus profond pour le premium */
            --foret: #2d4a2d;
            /* Plus profond/élégant */
            --sable: #D8B48F;
            --creme: #FAF9F6;
            /* Off-white plus pur */
            --noir: #1A1A1A;
            /* Noir moins dur */

            /* Statuts */
            --gratuit: #16A34A;
            --abordable: #F59E0B;
            --premium: #DC2626;

            /* UI Premium */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
            --radius: 16px;
            /* Plus moderne */
            --radius-sm: 8px;

            /* Typographie Premium */
            --font-display: 'Playfair Display', serif;
            --font-body: 'Inter', sans-serif;
            --font-mono: 'Roboto Mono', monospace;

            /* Mode clair (défaut) */
            --bg-primary: var(--creme);
            --bg-secondary: #FFFFFF;
            --text-primary: var(--noir);
            --text-secondary: #525252;
            /* Gris plus chaud */
            --border-color: #E5E5E5;
        }

        [data-theme="dark"] {
            --bg-primary: #121212;
            --bg-secondary: #1E1E1E;
            --text-primary: #EDE9E4;
            --text-secondary: #A3A3A3;
            --border-color: #262626;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Apply to HTML/ROOT to ensure scrollbars and native inputs are affected */
        html.dark-mode,
        body.dark-mode {
            color-scheme: dark;
        }

        /* ============================================
           HEADER PREMIUM (NON SCROLLABLE)
           ============================================ */
        .header-premium {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: linear-gradient(135deg, var(--laterite) 0%, var(--foret) 100%);
            color: white;
            padding: 16px 20px;
            box-shadow: var(--shadow-lg);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            flex-direction: column;
            gap: 12px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            gap: 16px;
        }

        .header-left {
            flex: 1;
        }

        .header-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badge-premium {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: var(--noir);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }



        .btn-locate {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            background: white;
            color: var(--laterite);
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s ease;
        }

        .btn-locate:hover {
            transform: scale(1.05);
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        /* ============================================
           NAVIGATION SCROLLABLE
           ============================================ */
        .nav-container {
            position: sticky;
            top: 80px;
            z-index: 999;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .nav-container::-webkit-scrollbar {
            display: none;
        }

        .main-nav {
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            min-width: max-content;
        }

        .nav-btn {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 24px;
            padding: 10px 20px;
            font-family: var(--font-body);
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-btn:hover {
            background: var(--laterite);
            border-color: var(--laterite);
            color: white;
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: var(--laterite);
            border-color: var(--laterite);
            color: white;
            font-weight: 600;
        }

        /* ============================================
           MAIN CONTENT
           ============================================ */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============================================
           CARTE INTERACTIVE
           ============================================ */
        #map {
            height: 500px;
            width: 100%;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            margin-bottom: 20px;
        }

        .map-filters {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .filter-group {
            margin-bottom: 16px;
        }

        .filter-group:last-child {
            margin-bottom: 0;
        }

        .filter-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-checkbox {
            display: none;
        }

        .filter-label {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .filter-checkbox:checked+.filter-label {
            background: var(--laterite);
            border-color: var(--laterite);
            color: white;
            font-weight: 500;
        }

        .filter-label:hover {
            border-color: var(--laterite);
        }

        /* ============================================
           SHORTCUTS RAPIDES
           ============================================ */
        /* Shortcuts styles defined later in the file for map page specificity */


        .shortcut-card {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .shortcut-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--laterite);
        }

        .shortcut-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .shortcut-title {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .shortcut-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* ============================================
           FILTRES PREMIUM (VILLE DÉTAIL)
           ============================================ */
        .filter-scroll-container {
            overflow-x: auto;
            white-space: nowrap;
            padding: 10px 4px;
            margin-bottom: 20px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            /* Firefox */
        }

        .filter-scroll-container::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari */
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: #F3F4F6;
            /* Gris très clair */
            color: var(--noir);
            border: 1px solid transparent;
            border-radius: 50px;
            padding: 10px 20px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-right: 10px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .filter-chip:last-child {
            margin-right: 0;
        }

        .filter-chip svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            transition: transform 0.3s ease;
        }

        .filter-chip:hover {
            background-color: #E5E7EB;
        }

        .filter-chip.active {
            background-color: var(--noir);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-1px);
        }

        .filter-chip.active svg {
            transform: scale(1.1);
        }

        /* Animation Fade pour le filtrage */
        .lieu-card.fade-in {
            animation: cardFadeIn 0.4s ease forwards;
        }

        @keyframes cardFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Bannière Agenda (Invisible par défaut) */
        .agenda-banner {
            display: none;
            /* Caché par défaut */
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 16px;
            border-radius: var(--radius);
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            align-items: center;
            gap: 12px;
            animation: slideDown 0.4s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .agenda-icon {
            font-size: 1.5rem;
            background: rgba(255, 255, 255, 0.2);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        /* ============================================
           CARDS LIEUX
           ============================================ */
        .lieux-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .lieu-card {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .lieu-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--laterite);
        }

        .lieu-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: var(--sable);
        }

        .lieu-content {
            padding: 16px;
        }

        .lieu-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }

        .lieu-title {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .badge-spot {
            background: var(--laterite);
            color: white;
            padding: 6px 24px;
            /* Plus large / En longueur */
            border-radius: 50px;
            /* Pill shape */
            font-size: 0.75rem;
            font-weight: 700;
            white-space: nowrap;
            flex-shrink: 0;
            text-align: center;
            min-width: 110px;
            /* Ensure minimum length */
            letter-spacing: 0.5px;
        }

        .badge-type {
            background: rgba(46, 125, 50, 0.1);
            /* Soft Green bg */
            color: #2E7D32;
            padding: 4px 10px;
            border-radius: 6px;
            /* Pill but slightly squared */
            font-size: 0.75rem;
            font-weight: 700;
            white-space: nowrap;
            letter-spacing: 0.3px;
        }

        /* NEW CARD STYLES */
        .card-image-badge-city {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .lieu-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 10px;
        }

        .lieu-title {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.3;
        }

        .lieu-meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .lieu-note {
            font-weight: 700;
            color: #FFD700;
            /* Gold */
            font-size: 0.9rem;
            background: rgba(255, 215, 0, 0.1);
            padding: 2px 6px;
            border-radius: 6px;
            white-space: nowrap;
        }

        .btn-details.full-width {
            width: 100%;
            margin-top: 12px;
            border-radius: 8px;
            padding: 10px;
            font-weight: 600;
            background: var(--laterite);
            /* Red */
        }

        .btn-details.full-width:hover {
            background: #b03030;
        }



        /* PREMIUM SEGMENTED CONTROL */
        .segmented-control-container {
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
            padding: 0 16px;
        }

        .segmented-control {
            display: flex;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: 50px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 320px;
            position: relative;
        }

        .segment-btn {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 40px;
            font-family: var(--font-body);
            /* Inter */
            font-weight: 600;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .segment-btn.active {
            background: var(--laterite);
            color: white;
            box-shadow: 0 2px 8px rgba(176, 48, 48, 0.25);
        }

        .lieu-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .lieu-prix {
            font-family: var(--font-mono);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .lieu-prix.gratuit {
            color: var(--gratuit);
        }

        .lieu-prix.abordable {
            color: var(--abordable);
        }

        .lieu-prix.premium {
            color: var(--premium);
        }

        .lieu-note {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .lieu-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .btn-details {
            width: 100%;
            background: var(--laterite);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: 12px;
            font-family: var(--font-body);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-website {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: linear-gradient(135deg, #2E7D32, #1B5E20);
            color: white;
            padding: 12px;
            border-radius: var(--radius);
            font-weight: 600;
            text-decoration: none;
            margin-top: 15px;
            transition: transform 0.2s ease;
            box-shadow: var(--shadow-md);
        }

        .btn-website:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-details:hover {
            background: #A12929;
            transform: scale(1.02);
        }

        .btn-details:active {
            transform: scale(0.98);
        }

        /* ============================================
           MODAL DÉTAILS
           ============================================ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            overflow-y: auto;
            animation: fadeIn 0.2s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.7);
            transform: scale(1.1);
        }

        .modal-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-title {
            font-family: var(--font-display);
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--laterite);
        }

        .modal-section-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .modal-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .modal-info-item {
            background: var(--bg-primary);
            padding: 12px;
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--laterite);
        }

        .modal-info-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .modal-info-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* ============================================
           LANGUE - ACCORDÉONS
           ============================================ */
        .langue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 2px solid var(--border-color);
            border-radius: 24px;
            font-family: var(--font-body);
            font-size: 0.95rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--laterite);
            box-shadow: 0 0 0 3px rgba(193, 53, 53, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .accordion-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .accordion-item {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 2px solid transparent;
            transition: border-color 0.2s ease;
        }

        .accordion-item.open {
            border-color: var(--laterite);
        }

        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            user-select: none;
            background: var(--bg-secondary);
            transition: background 0.2s ease;
        }

        .accordion-header:hover {
            background: var(--bg-primary);
        }

        .accordion-title {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .accordion-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .accordion-item.open .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .accordion-item.open .accordion-body {
            max-height: 2000px;
        }

        .accordion-content {
            padding: 0 20px 20px 20px;
        }

        .phrase-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .phrase-item:hover {
            background: var(--bg-secondary);
            transform: translateX(4px);
        }

        .phrase-content {
            flex: 1;
        }

        .phrase-fr {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .phrase-mg {
            color: var(--laterite);
            font-weight: 600;
            margin-bottom: 2px;
        }

        .phrase-phonetic {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-style: italic;
        }

        .phrase-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: var(--laterite);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .btn-icon:hover {
            background: #A12929;
            transform: scale(1.1);
        }

        .btn-icon:active {
            transform: scale(0.9);
        }

        .btn-icon.favorite.active {
            background: #FFD700;
            color: var(--noir);
        }

        /* Fix pour l'alignement de l'étoile dans la liste */
        .phrase-actions .btn-favorite {
            position: static;
            background: var(--laterite);
            color: white;
            width: 36px;
            height: 36px;
            box-shadow: none;
        }

        .phrase-actions .btn-favorite.active {
            background: #FFD700;
            color: var(--noir);
        }

        /* ============================================
           OUTILS
           ============================================ */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .tool-card {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .tool-title {
            font-family: var(--font-display);
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .converter-inputs {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .converter-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .converter-input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 1.1rem;
            font-weight: 500;
            background: var(--bg-primary);
            color: var(--text-primary);
            text-align: center;
        }

        .converter-input:focus {
            outline: none;
            border-color: var(--laterite);
        }

        .converter-label {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 50px;
        }

        .rate-info {
            text-align: center;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .btn-modify {
            margin-top: 12px;
            background: var(--foret);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: 10px 16px;
            font-family: var(--font-body);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-modify:hover {
            background: #2D4A2D;
        }

        .checklist-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checklist-item:hover {
            background: var(--bg-secondary);
            transform: translateX(4px);
        }

        .checklist-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .checklist-item.checked .checklist-checkbox {
            background: var(--gratuit);
            border-color: var(--gratuit);
        }

        .checklist-checkbox::after {
            content: '✓';
            color: white;
            font-weight: bold;
            display: none;
        }

        .checklist-item.checked .checklist-checkbox::after {
            display: block;
        }

        .checklist-label {
            flex: 1;
            color: var(--text-primary);
        }

        .checklist-item.checked .checklist-label {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .seasonal-advice {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .advice-item {
            padding: 16px;
            border-radius: var(--radius-sm);
            border-left: 4px solid;
        }

        .advice-item.good {
            background: rgba(22, 163, 74, 0.1);
            border-color: var(--gratuit);
        }

        .advice-item.warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--abordable);
        }

        .advice-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .advice-list {
            color: var(--text-secondary);
            font-size: 0.9rem;
            list-style-position: inside;
        }

        .contacts-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .contact-group-title {
            font-weight: 600;
            color: var(--laterite);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .contact-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
        }

        .contact-name {
            color: var(--text-primary);
        }

        .contact-number {
            font-family: var(--font-mono);
            color: var(--laterite);
            font-weight: 500;
        }

        /* ============================================
           MAP STYLES
           ============================================ */
        /* ============================================
           CARTE & FILTRES PREMIUM (Design Expert)
           ============================================ */
        #page-carte {
            /* display set by active class */
            position: relative;
            height: auto;
            /* REMOVED min-height: 100vh - was causing shortcuts to float inside */
            position: relative;
            padding: 0;
            margin: 0 -20px 0 -20px;
            padding-bottom: 0;
            /* Reduced from 80px */
        }

        #map-container {
            /* Fixed height block - increased for better visibility */
            height: 75vh;
            min-height: 450px;
            max-height: 800px;
            width: 100%;
            position: relative;
            z-index: 1;
            overflow: hidden;
            /* CRITIQUE: empêche la carte Leaflet de déborder */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            /* Positive margin to force shortcuts down */
            margin-bottom: 20px;
            border-bottom: 8px solid var(--bg-primary);
            /* Physical separator */
        }

        #map {
            height: 100%;
            width: 100%;
            border-radius: 0;
            z-index: 1;
        }

        /* ============================================
           PREMIUM UI COMPONENTS (Added via Refactor)
           ============================================ */

        /* Accordéons Premium (Glassmorphism) */
        .premium-section-header,
        .logistique-header,
        .premium-accordion-header {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .premium-section-header,
        [data-theme="dark"] .logistique-header,
        [data-theme="dark"] .premium-accordion-header {
            background: rgba(45, 45, 45, 0.95);
            /* Plus opaque pour contraste */
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            /* Bordure plus visible */
            color: var(--text-primary);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .premium-section-header:hover,
        .logistique-header:hover,
        .premium-accordion-header:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] .premium-section-header:hover,
        [data-theme="dark"] .logistique-header:hover {
            background: rgba(40, 40, 40, 0.8);
        }

        /* BANNIERE CIRCUITS (Harmonized) */
        .premium-banner-circuits {
            background: linear-gradient(135deg, #0F2027, #203A43, #2C5364);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border-radius: 0 0 24px 24px;
            margin-bottom: 24px;
            padding: 32px 20px 40px;
            color: white;
            text-align: center;
        }

        /* Titres Accordéons */
        .logistique-title,
        .premium-accordion-title,
        .premium-section-header h3,
        .logistique-header h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
            color: var(--text-primary);
        }

        /* DARK MODE TEXT FIX - GLOBAL */
        [data-theme="dark"] .logistique-header h3,
        [data-theme="dark"] .premium-accordion-header h3,
        [data-theme="dark"] .logistique-header i,
        [data-theme="dark"] .premium-accordion-header i {
            color: #FFFFFF !important;
            /* Forces White Title and Icon */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Remove Yellow on Icons - Use Primary Color or White in Dark Mode */
        .logistique-header i,
        .premium-accordion-header i {
            color: var(--laterite);
            /* Primary color instead of Gold */
            margin-right: 10px;
        }

        /* CONTENU ACCORDEON - PREMIUM RENDERING */
        .logistique-content,
        .premium-accordion-content {
            background: white;
            border-radius: 0 0 16px 16px;
            padding: 24px;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.05);
            /* Inset shadow for depth */
            margin-top: -10px;
            margin-bottom: 24px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            display: none;
            color: var(--text-secondary);
            /* Default dark grey text */
        }

        .logistique-content.active,
        .premium-accordion-content.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        /* DARK MODE CONTENT FIX - CRITICAL */
        [data-theme="dark"] .logistique-content,
        [data-theme="dark"] .premium-accordion-content {
            background: #2D2D2D;
            /* Solid dark grey background, no transparency issues */
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #E0E0E0 !important;
            /* Force Light Text */
        }

        [data-theme="dark"] .logistique-content strong,
        [data-theme="dark"] .premium-accordion-content strong {
            color: #FFFFFF;
            /* Highlight bold text */
        }

        [data-theme="dark"] .logistique-label {
            color: var(--lagon);
            /* Light Blue/Green for labels in Dark Mode */
            font-weight: 700;
            display: block;
            margin-bottom: 4px;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        /* FIX: Logistique Item styling to replace "Yellow" border */
        .logistique-item {
            padding-left: 12px;
            border-left: 3px solid var(--laterite);
            /* Harmony: Use theme color */
            margin-bottom: 16px;
        }

        /* FIX: Logistique Text visibility in Dark Mode */
        .logistique-text {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        [data-theme="dark"] .logistique-text {
            color: #E0E0E0 !important;
            /* Force readable text */
        }

        [data-theme="dark"] .logistique-item {
            border-left-color: var(--lagon);
            /* Use Lagon or generic theme color in dark mode? User asked for harmony. Lagon matches the banner? Or Laterite matches the brand? Let's use Laterite for brand consistency or Lagon for the 'Diego' vibe. User said 'yellow ... clashes'. Let's stick to Laterite (Red/Rust) as it is the main brand color, or maybe White/Grey? Laterite is safe. Actually, let's use var(--text-primary) or just keep Laterite. */
            border-left-color: var(--laterite);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Circuits Header (Dark Mode Fix) */
        .itinerary-header {
            background: var(--surface-card);
            /* Utilise la variable thème */
            border-bottom: 1px solid var(--border-color);
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .itinerary-header:hover {
            background: var(--bg-secondary);
        }

        /* ============================================
           NEW: PROVINCE FILTER BAR (Sticky & Native)
           ============================================ */
        .province-filter-container {
            position: sticky;
            top: 68px;
            /* Below Header */
            z-index: 900;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            margin: 0 -20px 20px -20px;
            /* Full width mobile */
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            /* Hide scrollbar Firefox */
        }

        [data-theme="dark"] .province-filter-container {
            background: rgba(18, 18, 18, 0.95);
        }

        .province-filter-container::-webkit-scrollbar {
            display: none;
            /* Hide scrollbar Chrome/Safari */
        }

        .filter-pill {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0 32px;
            /* Wide padding */
            height: 60px;
            /* Distinctly larger than 48px */
            border-radius: 50px;
            font-size: 1.05rem;
            /* Larger text */
            font-weight: 700;
            /* Bolder */
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .filter-pill:hover {
            border-color: var(--laterite);
            color: var(--laterite);
        }

        .filter-pill.active {
            background: var(--laterite);
            border-color: var(--laterite);
            color: white;
            box-shadow: 0 4px 10px rgba(176, 48, 48, 0.3);
        }

        /* ============================================
           NEW: BUDGET BADGES (Integrated in Cards)
           ============================================ */
        .badge-budget {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 8px;
            letter-spacing: 0.5px;
        }

        .budget-low {
            background: rgba(22, 163, 74, 0.1);
            color: #16A34A;
            /* Green / Eco */
            border: 1px solid rgba(22, 163, 74, 0.2);
        }

        .budget-mid {
            background: rgba(176, 48, 48, 0.1);
            color: var(--laterite);
            /* Standard Brand Color */
            border: 1px solid rgba(176, 48, 48, 0.2);
        }

        .budget-high {
            background: rgba(212, 175, 55, 0.1);
            color: #D4AF37;
            /* Gold / Premium */
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        /* Dark mode adj for badges */
        [data-theme="dark"] .budget-low {
            background: rgba(22, 163, 74, 0.2);
        }

        [data-theme="dark"] .budget-mid {
            background: rgba(176, 48, 48, 0.2);
        }

        [data-theme="dark"] .budget-high {
            background: rgba(212, 175, 55, 0.2);
        }

        /* Integrated placement in card header row */
        .lieu-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        /* Segment Control (Switcher Diego/Nosy Be) - Refined */
        .segmented-control-container {
            margin-bottom: 16px;
            /* Reduced spacing */
        }

        .segmented-control {
            background: var(--bg-secondary);
            border-radius: 50px;
            padding: 6px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            max-width: 340px;
            /* Larger but harmonious */
            margin: 0 auto;
        }

        .segmented-control-container {
            display: flex;
            justify-content: center;
            /* Center the badges */
            margin: 0 0 24px 0;
            /* Remove top margin, keep bottom */
            width: 100%;
        }

        .segmented-control {
            display: inline-flex;
            gap: 12px;
            /* Space between buttons */
            align-items: center;
        }

        .segment-btn {
            padding: 12px 28px;
            /* Larger comfortable click area */
            font-size: 1.0rem;
            /* Readable text */
            border-radius: 40px;
            font-weight: 600;
            white-space: nowrap;
            /* FORCE HORIZONTAL */
            text-transform: uppercase;
            /* Match Premium Look */
            letter-spacing: 0.5px;
        }

        /* BANNIERES PREMIUM */
        .premium-banner-tout {
            background: linear-gradient(135deg, var(--laterite), #A12929);
            box-shadow: 0 4px 15px rgba(161, 41, 41, 0.3);
            border-radius: 0 0 24px 24px;
            margin-bottom: 24px;
            padding: 32px 20px 40px;
            color: white;
            text-align: center;
        }

        .premium-banner-explorer {
            background: linear-gradient(135deg, var(--lagon), #047857);
            box-shadow: 0 4px 15px rgba(4, 120, 87, 0.3);
            border-radius: 0 0 24px 24px;
            margin-bottom: 24px;
            padding: 32px 20px 20px;
            color: white;
            text-align: center;
        }

        .premium-banner-diego {
            background: linear-gradient(135deg, #00C9FF, #92FE9D);
            /* Lagon / Turquoise vibe */
            box-shadow: 0 4px 15px rgba(0, 201, 255, 0.3);
            border-radius: 0 0 24px 24px;
            margin-bottom: 24px;
            padding: 32px 20px 40px;
            color: white;
            text-align: center;
        }

        .premium-banner-diego .city-title {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            color: white;
            /* Ensure text is white */
        }

        .premium-banner-diego .city-desc {
            color: rgba(255, 255, 255, 0.95);
            font-weight: 500;
        }

        .premium-banner-tout .city-title,
        .premium-banner-explorer .city-title {
            color: white;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .premium-banner-tout .city-desc,
        .premium-banner-explorer .city-desc {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        /* EXPLORER FILTERS */
        .explorer-filters-container {
            padding: 0 16px;
            margin-top: -10px;
            position: relative;
            z-index: 10;
        }

        .explorer-filters-container .nav-pills {
            justify-content: center;
        }

        /* FILTRES FLOTTANTS ÉPURÉS */
        .map-filters-overlay {
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 800px;
            z-index: 900;
            display: flex;
            justify-content: center;
            pointer-events: none;
        }

        .filter-row {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 8px;
            pointer-events: auto;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            max-width: 100%;
        }

        .filter-chip-map {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-chip-map:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .filter-chip-map.active {
            background: var(--laterite);
            color: white;
            box-shadow: 0 2px 8px rgba(217, 79, 4, 0.3);
        }

        /* BOUTON LOCALISATION */
        .btn-locate {
            position: absolute;
            bottom: 24px;
            right: 24px;
            z-index: 900;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            background: white;
            color: var(--laterite);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .btn-locate span {
            display: none;
        }

        /* ============================================
           MODALE FICHE LIEU (FIX STYLES)
           ============================================ */
        #lieuModal .modal-content {
            padding: 0;
            /* Cover image goes to edge */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 85vh;
        }

        .modal-header-image {
            width: 100%;
            height: 250px;
            position: relative;
            background: #eee;
        }

        .modal-header-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .modal-badge-type {
            position: absolute;
            bottom: 16px;
            left: 16px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            backdrop-filter: blur(4px);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 12px;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .modal-meta-row {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .meta-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            background: var(--bg-primary);
            padding: 6px 12px;
            border-radius: 8px;
        }

        .meta-tag::before {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
        }

        .meta-tag.price::before {
            content: "\f53a";
            color: var(--laterite);
        }

        /* Money Bill */
        .meta-tag.duration::before {
            content: "\f017";
            color: var(--laterite);
        }

        /* Clock */
        .meta-tag.access::before {
            content: "\f3c5";
            color: var(--laterite);
        }

        /* Map Marker */

        .modal-description {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .modal-advice-box {
            background: rgba(255, 215, 0, 0.1);
            border-left: 4px solid #FFD700;
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 24px;
        }

        .advice-title {
            font-weight: 700;
            color: #b59802;
            margin-bottom: 8px;
        }

        .btn-action-primary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px;
            background: var(--laterite);
            color: white;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            transition: transform 0.2s;
        }

        .btn-action-primary:hover {
            transform: translateY(-2px);
            background: #c04000;
        }


        /* SHORTCUTS RAPIDES (High Visibility) */
        /* SHORTCUTS RAPIDES (High Visibility) */
        .shortcuts-grid {
            /* Clear separation */
            margin-top: 20px;
            position: relative;
            z-index: 10;
            clear: both;
            /* Ensure no floating issues */
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            padding: 20px;
            background: var(--bg-primary);
        }

        .shortcut-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px;
            /* Plus compact */
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            /* Plus subtil */
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            text-align: left;
            height: 100%;
        }

        .shortcut-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--laterite);
        }

        .shortcut-icon {
            font-size: 2rem;
            /* Plus compact */
            margin-bottom: 8px;
            display: block;
        }

        .shortcut-title {
            font-size: 1.1rem;
            /* Plus compact */
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .shortcut-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .shortcuts-grid {
                grid-template-columns: 1fr;
                padding: 20px;
            }

            .shortcut-card {
                padding: 20px;
            }
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
            .header-title {
                font-size: 1.2rem;
            }

            .header-tagline {
                font-size: 0.8rem;
            }

            .theme-toggle {
                width: 44px;
                height: 44px;
            }

            .nav-container {
                top: 72px;
            }

            .main-nav {
                padding: 10px 16px;
                gap: 6px;
            }

            .nav-btn {
                padding: 8px 16px;
                font-size: 0.85rem;
            }

            .main-content {
                padding: 16px;
            }

            #map {
                height: 400px;
            }

            .shortcuts-grid {
                grid-template-columns: 1fr;
            }

            .lieux-grid {
                grid-template-columns: 1fr;
            }

            .tools-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 10px;
            }

            .modal-title {
                font-size: 1.5rem;
            }
        }

        @media (min-width: 1024px) {
            #map {
                height: 600px;
            }
        }

        /* ============================================
           UTILITAIRES
           ============================================ */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        /* Leaflet popup customization */
        /* Leaflet popup customization - Premium */
        .leaflet-popup-content-wrapper {
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            padding: 0;
            overflow: hidden;
            border: 2px solid var(--laterite);
            background: var(--bg-primary);
        }

        .leaflet-popup-content {
            margin: 0;
            width: 280px !important;
        }

        .popup-image-container {
            height: 140px;
            width: 100%;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .btn-favorite-popup-overlay {
            position: absolute;
            top: 10px;
            right: 10px;

            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;

            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);

            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            color: #4b5563;
            font-size: 1.1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-favorite-popup-overlay:hover {
            transform: scale(1.1);
            background: #ffffff;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .btn-favorite-popup-overlay:active {
            transform: scale(0.95);
        }

        .btn-favorite-popup-overlay.active {
            color: var(--premium);
        }

        .popup-body {
            padding: 12px 16px 16px 16px;
        }

        .popup-title {
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 1.15rem;
            color: var(--text-primary);
            line-height: 1.3;
            margin: 0 0 4px 0;
        }

        .popup-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .popup-type-badge {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            backdrop-filter: blur(4px);
        }

        .popup-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .popup-price {
            font-family: var(--font-mono);
            font-weight: 700;
            color: var(--laterite);
            font-size: 1rem;
            background: rgba(217, 79, 4, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
        }

        .popup-rating {
            font-size: 0.9rem;
            color: #F59E0B;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-popup-details {
            display: block;
            width: 100%;
            padding: 12px;
            background: var(--laterite);
            color: white;
            text-align: center;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            margin-top: 12px;
            box-shadow: 0 4px 6px rgba(217, 79, 4, 0.2);
        }

        .btn-popup-details:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(217, 79, 4, 0.3);
            background: #c2410b;
        }

        .btn-favorite-popup {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #ccc;
            transition: all 0.2s;
            flex-shrink: 0;
            box-shadow: var(--shadow);
        }

        .btn-favorite-popup.active {
            color: var(--premium);
            border-color: var(--premium);
            background: #fff9e6;
        }

        .btn-favorite-popup:hover {
            transform: scale(1.1);
        }

        /* Installation prompt */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--laterite);
            color: white;
            padding: 16px 24px;
            border-radius: 50px;
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            animation: slideUp 0.3s ease;
        }

        .install-prompt.active {
            display: flex;
        }

        .install-btn {
            background: white;
            color: var(--laterite);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .install-btn:hover {
            transform: scale(1.05);
        }

        .install-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            margin-left: 8px;
        }

        /* FAVORITES STYLES */
        /* FAVORITES STYLES */
        .btn-favorite {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 10;

            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;

            background: rgba(255, 255, 255, 0.95);
            /* Quasi opaque pour contraste max */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
            /* Ombre marquée pour détacher du fond */

            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);

            color: #4b5563;
            /* Gris foncé neutre par défaut */
            font-size: 1.1rem;
        }

        .btn-favorite:hover {
            transform: scale(1.1);
            background: #ffffff;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .btn-favorite:active {
            transform: scale(0.95);
        }

        .btn-favorite.active {
            color: var(--premium);
        }

        /* --- Outil Taxi-Brousse Premium --- */
        .taxi-calculator {
            margin-bottom: 24px;
            background: var(--surface);
            padding: 20px;
            border-radius: 16px;
            /* Ne pas doubler le background si tool-card l'a déjà, mais ajuster le padding interne */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .taxi-form {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: 0.02em;
        }

        .form-group-icon {
            font-size: 1.2rem;
            color: var(--laterite);
            background: rgba(176, 48, 48, 0.1);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-top: 24px;
            /* Align with inputs */
        }

        .taxi-select {
            width: 100%;
            padding: 12px 34px 12px 12px;
            /* Less vertical, more right padding for icon */
            border-radius: 12px;
            border: 1px solid var(--border);
            background-color: var(--background);
            /* Explicit color for inheritance */
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            /* Slightly smaller to fit Antananarivo */
            font-weight: 500;
            appearance: none;
            -webkit-appearance: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            transition: all 0.2s ease;
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23b03030' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }

        /* Force dark option background in Dark Mode */
        body.dark-mode .taxi-select {
            color-scheme: dark;
            background-color: #000000 !important;
            color: #ffffff !important;
            border-color: #555;
        }

        body.dark-mode .taxi-select option {
            background-color: #000000 !important;
            color: #ffffff !important;
            text-shadow: none;
        }

        .taxi-select:focus {
            border-color: var(--laterite);
            outline: none;
            box-shadow: 0 0 0 3px rgba(176, 48, 48, 0.15);
        }

        .btn-action-primary {
            background: linear-gradient(135deg, var(--laterite) 0%, #d64d4d 100%);
            color: white;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            letter-spacing: 0.5px;
            border: none;
            box-shadow: 0 4px 12px rgba(176, 48, 48, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-action-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(176, 48, 48, 0.4);
        }

        .taxi-result {
            background: linear-gradient(135deg, rgba(176, 48, 48, 0.08), rgba(255, 255, 255, 0.02));
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(176, 48, 48, 0.15);
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }

        .taxi-result::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--laterite);
            opacity: 0.8;
        }

        .price-tiers-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 15px 0;
        }

        .tier-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        body.dark-mode .tier-row {
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .tier-name {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .tier-price {
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            color: var(--laterite);
            font-size: 1.1rem;
        }

        .result-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 12px;
        }

        .result-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .result-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .result-value {
            font-family: 'Outfit', sans-serif;
            /* Plus stylisé pour les chiffres */
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--laterite);
            line-height: 1.2;
        }

        .result-note {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
            opacity: 0.8;
        }

        .companies-section {
            margin-top: 24px;
            animation: fadeIn 0.4s ease-out;
        }

        .companies-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin-top: 16px;
        }

        .company-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .company-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.06);
            border-color: var(--laterite);
        }

        .company-info strong {
            display: block;
            color: var(--text-primary);
            font-size: 1.05rem;
            margin-bottom: 6px;
            font-family: 'Outfit', sans-serif;
        }

        .company-badge.premium {
            background: linear-gradient(90deg, var(--laterite), #d64d4d);
            color: white;
            border: none;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(176, 48, 48, 0.25);
        }

        .company-actions {
            display: flex;
            gap: 10px;
        }

        .btn-icon-small {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--background);
            border: 1px solid var(--border);
            transition: all 0.2s;
            font-size: 1.1rem;
            text-decoration: none;
        }

        .btn-icon-small:hover {
            background: var(--laterite);
            color: white;
            border-color: var(--laterite);
            transform: scale(1.1);
        }

        /* --- Styles pour Cartes Raccourcis --- */
        /* Optionnel: fond légèrement teinté */
        /* background: #fff5f5; */
        }

        .btn-favorite.active i {
            /* Anime l'icône si besoin */
            mix-blend-mode: normal;
        }

        /* CONVERTER STYLES */
        .converter-select {
            flex: 1;
            padding: 8px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-body);
        }

        .btn-icon-small {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.1rem;
        }

        .status-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.manual {
            background: #F59E0B;
            color: white;
        }

        .status-badge.live {
            background: #10B981;
            color: white;
        }

        .btn-text-action {
            background: none;
            border: none;
            color: var(--laterite);
            font-size: 0.8rem;
            text-decoration: underline;
            cursor: pointer;
            margin-left: 10px;
        }

        /* ============================================
           FILTRES INTELLIGENTS (PREMIUM UI)
           ============================================ */
        .nav-pills {
            display: flex;
            gap: 12px;
            padding: 4px 4px 12px 4px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            margin-bottom: 24px;
            align-items: center;
        }

        .nav-pills::-webkit-scrollbar {
            display: none;
        }

        .nav-pill {
            background: var(--bg-secondary);
            border: 1px solid rgba(0, 0, 0, 0.08);
            /* Plus subtil */
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 50px;
            font-family: var(--font-body);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            /* Ombre douce initiale */
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
            background: white;
            border-color: rgba(0, 0, 0, 0.05);
        }

        .nav-pill:active {
            transform: scale(0.96);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .nav-pill.active {
            background: linear-gradient(135deg, var(--laterite) 0%, #A12929 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 6px 15px rgba(217, 79, 4, 0.4);
            /* Glow rouge */
        }

        /* ICON STYLES */
        .nav-pill i,
        .nav-btn i,
        .filter-chip-map i {
            font-size: 1.1em;
            /* Légèrement plus grand */
            margin-right: 2px;
        }

        .nav-btn i {
            margin-bottom: 2px;
            /* Alignement optique */
        }

        /* PREMIUM BANNERS */
        .premium-banner-tout,
        .premium-banner-explorer,
        .premium-banner-circuits {
            padding: 24px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, var(--laterite) 0%, #8a2424 100%);
            /* Worked Premium Red */
            color: white;
            transition: all 0.3s ease;
        }

        /* Banner Text */
        .city-title {
            font-family: var(--font-display);
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .city-desc {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        /* Dark Mode Override for Banners - Black with Red Accent */
        [data-theme="dark"] .premium-banner-tout,
        [data-theme="dark"] .premium-banner-explorer,
        [data-theme="dark"] .premium-banner-circuits {
            background: #1A1A1A;
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-left: 4px solid var(--laterite);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        /* Accordion Style Adjustment (Inline Override if needed) */
        /* See styles-premium.css for main styles */
        /* Badge Ville sur Image (Updated Request) */
        .card-image-badge-city {
            background: rgba(0, 0, 0, 0.65);
            /* More transparent/discreet */
            color: white;
            padding: 4px 10px;
            /* Ultra Compact */
            border-radius: 50px;
            font-size: 0.75rem;
            /* ~12px */
            font-weight: 600;
            backdrop-filter: blur(4px);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.15);
            white-space: nowrap;
            letter-spacing: 0.3px;
        }
    </style>
    <link rel="stylesheet" href="css/styles-premium.css">
</head>

<body>
    <header class="header-premium">
        <div class="header-content">
            <div class="header-top">
                <div>
                    <h1 class="header-title">
                        🌍 Gasikara Explorer
                        <span class="badge-premium">PREMIUM</span>
                    </h1>
                    <p class="header-tagline">Le guide connecté des terres rouges</p>
                </div>
                <button id="themeToggle" class="theme-toggle">☀️</button>
            </div>


        </div>
    </header>
    <nav class="nav-container">
        <div class="main-nav">
            <button class="nav-btn active" data-page="accueil"><i class="fa-solid fa-compass"></i> Tout</button>
            <button class="nav-btn" data-page="explorer"><i class="fa-solid fa-binoculars"></i> Explorer</button>
            <button class="nav-btn" data-page="itineraires"><i class="fa-solid fa-route"></i> Circuits</button>
            <button class="nav-btn" data-page="carte"><i class="fa-solid fa-map"></i> Carte</button>
            <button class="nav-btn" data-page="antananarivo"><i class="fa-solid fa-landmark"></i> Tana</button>
            <button class="nav-btn" data-page="antsiranana"><i class="fa-solid fa-anchor"></i> Diego</button>
            <button class="nav-btn" data-page="mahajanga"><i class="fa-solid fa-umbrella-beach"></i> Majunga</button>
            <button class="nav-btn" data-page="toamasina"><i class="fa-solid fa-ship"></i> Tamatave</button>
            <button class="nav-btn" data-page="toliara"><i class="fa-solid fa-sun"></i> Tuléar</button>
            <button class="nav-btn" data-page="fianarantsoa"><i class="fa-solid fa-train"></i> Fianar</button>
            <button class="nav-btn" data-page="outils"><i class="fa-solid fa-toolbox"></i> Outils</button>
            <button class="nav-btn" data-page="langue"><i class="fa-solid fa-comments"></i> Langue</button>
        </div>
    </nav>

    <!-- Main Content -->
    <!-- Main Content -->
    <main class="main-content">
        <!-- ACCUEIL (Tout) -->
        <section id="page-accueil" class="page-section active">
            <div class="city-header premium-banner-tout">
                <div class="banner-content">
                    <h2 class="city-title">Tout le Nord</h2>
                    <p class="city-desc">Tous les lieux, toutes les envies. Explorez sans limite.</p>
                </div>
            </div>
            <div id="all-lieux-container" class="lieux-grid"></div>
        </section>

        <!-- EXPLORER (Filtres) -->
        <section id="page-explorer" class="page-section">
            <div class="city-header premium-banner-explorer">
                <div class="banner-content">
                    <h2 class="city-title">Exploration</h2>
                    <p class="city-desc">Filtrer par catégorie, envie ou proximité.</p>
                </div>
            </div>

            <!-- UI FILTRES PROVINCE & BUDGET (Sticky) -->
            <div class="province-filter-container">
                <button class="filter-pill active" onclick="filterExplorerByZone('all', this)">Tout</button>
                <button class="filter-pill" onclick="filterExplorerByZone('Diego-Suarez', this)">Diego-Suarez</button>
                <button class="filter-pill" onclick="filterExplorerByZone('Nosy Be', this)">Nosy Be</button>
                <button class="filter-pill" onclick="filterExplorerByZone('Mahajanga', this)">Majunga</button>
                <button class="filter-pill" onclick="filterExplorerByZone('SAVA', this)">SAVA</button>
                <button class="filter-pill" onclick="filterExplorerByZone('Ankarana', this)">Ankarana</button>

                <div style="width:1px; height:24px; background:var(--border-color); margin:0 8px;"></div>

                <button class="filter-pill" onclick="toggleBudgetFilter('low', this)">€</button>
                <button class="filter-pill" onclick="toggleBudgetFilter('mid', this)">€€</button>
                <button class="filter-pill" onclick="toggleBudgetFilter('high', this)">€€€</button>
            </div>

            <!-- UI FILTRES CATEGORIES (Injecté pour Harmony) -->
            <div class="explorer-filters-container">
                <div class="nav-pills">
                    <label class="nav-pill filter-chip-map" data-filter="favorites"
                        onclick="toggleFilter(this, 'favorites')">
                        <input type="checkbox" id="filter-favorites-expl" style="display:none;">
                        <i class="fa-solid fa-heart"></i> Pépites
                    </label>
                    <label class="nav-pill filter-chip-map" data-filter="manger" onclick="toggleFilter(this, 'manger')">
                        <input type="checkbox" id="filter-manger-expl" style="display:none;">
                        <i class="fa-solid fa-utensils"></i> Manger
                    </label>
                    <label class="nav-pill filter-chip-map" data-filter="dodo" onclick="toggleFilter(this, 'dodo')">
                        <input type="checkbox" id="filter-dodo-expl" style="display:none;">
                        <i class="fa-solid fa-bed"></i> Dormir
                    </label>
                    <label class="nav-pill filter-chip-map" data-filter="activite"
                        onclick="toggleFilter(this, 'explorer')">
                        <input type="checkbox" id="filter-explorer-expl" style="display:none;">
                        <i class="fa-solid fa-binoculars"></i> Activités
                    </label>
                    <label class="nav-pill filter-chip-map" data-filter="sortir" onclick="toggleFilter(this, 'sortir')">
                        <input type="checkbox" id="filter-sortir-expl" style="display:none;">
                        <i class="fa-solid fa-music"></i> Sortir
                    </label>
                </div>
            </div>

            <div id="explorer-container" class="lieux-grid"></div>
        </section>

        <!-- ITINERAIRES -->
        <section id="page-itineraires" class="page-section">
            <div class="city-header premium-banner-tout">
                <div class="banner-content">
                    <h2 class="city-title">🗺️ Circuits Sur Mesure</h2>
                    <p class="city-desc">Des itinéraires clés en main, testés et approuvés pour tous les budgets.
                        Laissez-vous guider étape par étape.</p>
                </div>
            </div>
            <div id="itineraires-list" class="lieux-grid">
                <!-- Injected via JS -->
            </div>
            <div id="itineraire-detail" style="display:none;">
                <button onclick="backToItineraries()" class="btn-back-circuits">
                    <i class="fas fa-arrow-left"></i> Retour aux circuits
                </button>
                <div id="itineraire-content"></div>
            </div>
        </section>

        <!-- Page Carte -->
        <section id="page-carte" class="page-section active">
            <!-- Filtres -->
            <!-- Map Container with Overlay Filters -->
            <!-- Map Container with Overlay Filters -->
            <div id="map-container">
                <div id="map"></div>

                <!-- Filters Overlay (Smart Bar Harmonized) -->
                <div class="map-filters-overlay">
                    <div class="filter-row">
                        <!-- Villes (Navigation Rapide) -->
                        <div class="filter-chip-map active" onclick="toggleFilter(this, 'antananarivo')">
                            <input type="checkbox" id="filter-antananarivo" class="filter-checkbox" checked>
                            <i class="fa-solid fa-landmark"></i> Tana
                        </div>
                        <div class="filter-chip-map active" onclick="toggleFilter(this, 'antsiranana')">
                            <input type="checkbox" id="filter-antsiranana" class="filter-checkbox" checked>
                            <i class="fa-solid fa-anchor"></i> Diego
                        </div>
                        <div class="filter-chip-map active" onclick="toggleFilter(this, 'mahajanga')">
                            <input type="checkbox" id="filter-mahajanga" class="filter-checkbox" checked>
                            <i class="fa-solid fa-umbrella-beach"></i> Majunga
                        </div>
                        <div class="filter-chip-map active" onclick="toggleFilter(this, 'toamasina')">
                            <input type="checkbox" id="filter-toamasina" class="filter-checkbox" checked>
                            <i class="fa-solid fa-ship"></i> Tamatave
                        </div>
                        <div class="filter-chip-map active" onclick="toggleFilter(this, 'toliara')">
                            <input type="checkbox" id="filter-toliara" class="filter-checkbox" checked>
                            <i class="fa-solid fa-sun"></i> Tuléar
                        </div>
                        <div class="filter-chip-map active" onclick="toggleFilter(this, 'fianarantsoa')">
                            <input type="checkbox" id="filter-fianarantsoa" class="filter-checkbox" checked>
                            <i class="fa-solid fa-train"></i> Fianar
                        </div>

                        <div
                            style="width:1px; background:rgba(0,0,0,0.1); margin:0 4px; height:20px; align-self:center;">
                        </div>

                        <!-- Catégories Standardisées -->
                        <div class="filter-chip-map active" onclick="toggleFilter(this, 'explorer')">
                            <input type="checkbox" id="filter-explorer" class="filter-checkbox" checked>
                            <i class="fa-solid fa-binoculars"></i> Explorer
                        </div>
                        <div
                            style="width:1px; background:rgba(0,0,0,0.1); margin:0 4px; height:20px; align-self:center;">
                        </div>

                        <!-- Budget - New Filters -->
                        <div class="filter-chip-map active" onclick="toggleFilter(this, 'budget1')">
                            <input type="checkbox" id="filter-budget1" class="filter-checkbox" checked>
                            <span style="font-weight:700;">€</span>
                        </div>
                        <div class="filter-chip-map active" onclick="toggleFilter(this, 'budget2')">
                            <input type="checkbox" id="filter-budget2" class="filter-checkbox" checked>
                            <span style="font-weight:700;">€€</span>
                        </div>
                        <div class="filter-chip-map active" onclick="toggleFilter(this, 'budget3')">
                            <input type="checkbox" id="filter-budget3" class="filter-checkbox" checked>
                            <span style="font-weight:700;">€€€</span>
                        </div>

                        <div
                            style="width:1px; background:rgba(0,0,0,0.1); margin:0 4px; height:20px; align-self:center;">
                        </div>

                        <div class="filter-chip-map active" onclick="toggleFilter(this, 'manger')">
                            <input type="checkbox" id="filter-manger" class="filter-checkbox" checked>
                            <i class="fa-solid fa-utensils"></i> Manger
                        </div>
                        <div class="filter-chip-map active" onclick="toggleFilter(this, 'dodo')">
                            <input type="checkbox" id="filter-dodo" class="filter-checkbox" checked>
                            <i class="fa-solid fa-bed"></i> Dormir
                        </div>
                        <div class="filter-chip-map active" onclick="toggleFilter(this, 'sortir')">
                            <input type="checkbox" id="filter-sortir" class="filter-checkbox" checked>
                            <i class="fa-solid fa-martini-glass-citrus"></i> Sortir
                        </div>
                        <div class="filter-chip-map active" onclick="toggleFilter(this, 'spot')">
                            <input type="checkbox" id="filter-spot" class="filter-checkbox" checked>
                            <i class="fa-solid fa-map-pin"></i> Spots
                        </div>

                        <div
                            style="width:1px; background:rgba(0,0,0,0.1); margin:0 4px; height:20px; align-self:center;">
                        </div>

                        <div class="filter-chip-map active" onclick="toggleFilter(this, 'favorites')">
                            <input type="checkbox" id="filter-favorites" class="filter-checkbox">
                            <i class="fa-solid fa-heart"></i> Favoris
                        </div>
                    </div>
                </div>

                <button id="btnLocateMe" class="btn-locate" title="Autour de moi">
                    <i class="fas fa-location-crosshairs"></i>
                </button>
            </div>

            <!-- Shortcuts -->
            <div class="shortcuts-grid">
                <div class="shortcut-card" data-goto="spots">
                    <div class="shortcut-icon">🔥</div>
                    <h3 class="shortcut-title">Spots Locaux</h3>
                    <p class="shortcut-desc">9 lieux secrets accessibles uniquement via contact local</p>
                </div>

                <div class="shortcut-card" data-goto="langue">
                    <div class="shortcut-icon">🗣️</div>
                    <h3 class="shortcut-title">50+ Expressions</h3>
                    <p class="shortcut-desc">Phrases essentielles en malgache avec prononciation audio</p>
                </div>

                <div class="shortcut-card" data-goto="outils">
                    <div class="shortcut-icon">🧰</div>
                    <h3 class="shortcut-title">Outils Terrain</h3>
                    <p class="shortcut-desc">Convertisseur devises, checklist voyage, numéros utiles</p>
                </div>
            </div>
        </section>

        <!-- Pages Provinces (template dynamique) -->
        <section id="page-antananarivo" class="page-section"></section>
        <section id="page-antsiranana" class="page-section"></section>
        <section id="page-fianarantsoa" class="page-section"></section>
        <section id="page-mahajanga" class="page-section"></section>
        <section id="page-toamasina" class="page-section"></section>
        <section id="page-toliara" class="page-section"></section>

        <!-- Page Spots Locaux -->
        <section id="page-spots" class="page-section">
            <h2 class="page-title"
                style="font-family: var(--font-display); font-size: 2rem; margin-bottom: 20px; color: var(--laterite);">
                🔥 Spots Locaux Authentiques</h2>
            <p style="color: var(--text-secondary); margin-bottom: 30px; font-size: 1.1rem;">
                Ces lieux sont <strong>inaccessibles sans contact humain local</strong>. Non référencés sur Google Maps,
                absents des guides touristiques traditionnels.
            </p>
            <div id="spotsContainer" class="lieux-grid"></div>
        </section>

        <!-- Page Langue -->
        <section id="page-langue" class="page-section">
            <div class="langue-header">
                <h2 style="font-family: var(--font-display); font-size: 2rem; color: var(--text-primary);">🗣️
                    Expressions Malgaches</h2>
                <div class="search-box">
                    <span class="search-icon">🔍</span>
                    <input type="text" id="langueSearch" class="search-input"
                        placeholder="Rechercher une expression...">
                </div>
            </div>

            <div id="accordionContainer" class="accordion-container"></div>
        </section>

        <!-- Page Outils -->
        <section id="page-outils" class="page-section">
            <h2
                style="font-family: var(--font-display); font-size: 2rem; margin-bottom: 30px; color: var(--text-primary);">
                🧰 Outils Terrain</h2>

            <div class="tools-grid">
                <!-- Convertisseur -->
                <!-- Convertisseur Avancé -->
                <div class="tool-card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 class="tool-title" style="margin:0;">💱 Convertisseur</h3>
                        <div id="converterStatus" class="status-badge manual">Mode Manuel</div>
                    </div>

                    <div class="converter-controls" style="margin-bottom: 15px; display: flex; gap: 10px;">
                        <select id="currencySelector" class="converter-select">
                            <option value="EUR" selected>🇪🇺 Euro (€)</option>
                            <option value="USD">🇺🇸 Dollar ($)</option>
                            <option value="GBP">🇬🇧 Livre (£)</option>
                            <option value="CHF">🇨🇭 Franc Suisse</option>
                            <option value="ZAR">🇿🇦 Rand (R)</option>
                        </select>
                        <button id="btnRefreshRate" class="btn-icon-small" title="Actualiser taux officiel">🔄</button>
                    </div>

                    <div class="converter-inputs" id="converterInputsContainer">
                        <div class="converter-row" id="rowForeign">
                            <span class="converter-label" id="foreignLabel">€</span>
                            <input type="number" id="inputForeign" class="converter-input" value="10" min="0"
                                step="0.01">
                        </div>

                        <div class="converter-actions" style="display:flex; justify-content:center; margin: 10px 0;">
                            <button id="btnInvert" class="btn-icon-small" title="Inverser le sens"
                                style="transform: rotate(90deg);">⇄</button>
                        </div>

                        <div class="converter-row" id="rowLocal">
                            <span class="converter-label">Ar</span>
                            <input type="number" id="inputLocal" class="converter-input" value="50000" min="0">
                        </div>
                    </div>

                    <div class="rate-info">
                        <span id="rateText">1 € = 5000 Ar</span>
                        <button id="btnEditRate" class="btn-text-action">Modifier manuellement</button>
                    </div>
                </div>

                <!-- Checklist -->
                <div class="tool-card">
                    <h3 class="tool-title">✅ Checklist Voyage</h3>
                    <div class="checklist-items" id="checklistContainer"></div>
                </div>

                <!-- Conseils Saisonniers -->
                <div class="tool-card">
                    <h3 class="tool-title">📅 Conseils Saisonniers</h3>
                    <div class="seasonal-advice">
                        <div class="advice-item good">
                            <div class="advice-title">🌞 Meilleure période : MAI à OCTOBRE</div>
                            <ul class="advice-list">
                                <li>Météo stable, routes praticables</li>
                                <li>Observation lémuriens optimale</li>
                                <li>Températures agréables (20-25°C)</li>
                            </ul>
                        </div>
                        <div class="advice-item warning">
                            <div class="advice-title">⚠️ À éviter : JANVIER à MARS</div>
                            <ul class="advice-list">
                                <li>Saison des pluies (cyclones possibles)</li>
                                <li>Routes coupées, parcs fermés</li>
                                <li>Forte humidité</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Numéros Utiles -->
                <div class="tool-card">
                    <h3 class="tool-title">📞 Numéros Utiles</h3>
                    <div class="contacts-list">
                        <div>
                            <div class="contact-group-title">🚨 Urgences</div>
                            <div class="contact-item">
                                <span class="contact-name">Police</span>
                                <span class="contact-number">117</span>
                            </div>
                            <div class="contact-item">
                                <span class="contact-name">Pompiers</span>
                                <span class="contact-number">118</span>
                            </div>
                            <div class="contact-item">
                                <span class="contact-name">Ambulance</span>
                                <span class="contact-number">119</span>
                            </div>
                        </div>

                        <div>
                            <div class="contact-group-title">🏛️ Ambassades</div>
                            <div class="contact-item">
                                <span class="contact-name">France</span>
                                <span class="contact-number">+261 20 22 399 98</span>
                            </div>
                            <div class="contact-item">
                                <span class="contact-name">Belgique</span>
                                <span class="contact-number">+261 20 22 241 69</span>
                            </div>
                        </div>

                        <div>
                            <div class="contact-group-title">📶 Opérateurs</div>
                            <div class="contact-item">
                                <span class="contact-name">Telma</span>
                                <span class="contact-number">*111#</span>
                            </div>
                            <div class="contact-item">
                                <span class="contact-name">Airtel</span>
                                <span class="contact-number">*121#</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Outil Taxi-Brousse -->
                <div class="tool-card" id="tool-taxi">
                    <h3 class="tool-title"
                        style="font-family: 'Playfair Display', serif; font-size: 1.8rem; margin-bottom: 20px;">
                        <i class="fa-solid fa-van-shuttle" style="color: var(--laterite); margin-right: 10px;"></i>
                        Taxi-Brousse & Transports
                    </h3>

                    <div class="taxi-calculator">
                        <div class="taxi-form">
                            <div class="form-group">
                                <label>De</label>
                                <select id="taxiFrom" class="taxi-select">
                                    <!-- Populated by JS -->
                                </select>
                            </div>

                            <div class="form-group-icon">
                                <i class="fa-solid fa-arrow-right-arrow-left"></i>
                            </div>

                            <div class="form-group">
                                <label>Vers</label>
                                <select id="taxiTo" class="taxi-select">
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                        </div>

                        <button id="btnCalcTaxi" class="btn-action-primary"
                            style="width: 100%; padding: 16px; border-radius: 12px; margin-top: 10px;">
                            Estimer Trajet
                        </button>

                        <div id="taxiResult" class="taxi-result hidden">
                            <div class="result-row">
                                <div class="result-item">
                                    <span class="result-label">Durée Estimée</span>
                                    <span class="result-value" id="resDuration">--</span>
                                </div>
                            </div>

                            <div class="result-divider"
                                style="height: 1px; background: rgba(0,0,0,0.1); margin: 15px 0;"></div>

                            <div id="resPriceContainer" class="price-tiers-container">
                                <!-- Populated by JS -->
                            </div>

                            <div class="mt-20">
                                <span class="result-note">⚠️ Tarifs indicatifs (Lite / Premium / VIP)</span>
                            </div>

                            <div id="companiesSection" class="companies-section hidden">
                                <h4
                                    style="font-family: 'Playfair Display', serif; color: var(--text-primary); margin-bottom: 15px;">
                                    Compagnies Recommandées</h4>
                                <div id="companiesList" class="companies-list">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
        </section>
    </main>

    <!-- Modal Détails -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="modalClose">×</button>
            <img id="modalImage" class="modal-image" src="" alt="" loading="lazy">
            <div class="modal-body">
                <h2 id="modalTitle" class="modal-title"></h2>
                <div id="modalBadges" style="margin-bottom: 16px;"></div>
                <div id="modalInfoGrid" class="modal-info-grid"></div>
                <div id="modalSections"></div>
            </div>
        </div>
    </div>

    <!-- Install Prompt -->
    <div id="installPrompt" class="install-prompt">
        <span>📱 Installer l'app pour un accès offline</span>
        <button class="install-btn" id="installBtn">Installer</button>
        <button class="install-close" id="installClose">×</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>




    <!-- MODALE FICHE LIEU (CARTE - Fix) -->
    <div id="lieuModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>

            <div class="modal-header-image">
                <img id="modal-image" src="" alt="Lieu">
                <span id="modal-type" class="modal-badge-type"></span>
            </div>

            <div class="modal-body">
                <h2 id="modal-title" class="modal-title"></h2>

                <div class="modal-meta-row">
                    <span id="modal-price" class="meta-tag price"></span>
                    <span id="modal-duration" class="meta-tag duration"></span>
                    <span id="modal-access" class="meta-tag access"></span>
                </div>

                <div class="modal-description" id="modal-desc"></div>

                <div id="modal-advice-section" class="modal-advice-box">
                    <div class="advice-title">💡 Le conseil du local</div>
                    <p id="modal-advice"></p>
                </div>

                <a id="modal-link-btn" href="#" target="_blank" class="btn-action-primary">
                    <i class="fas fa-globe"></i> Visiter le site web
                </a>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // DONNÉES
        // ============================================


        const PHRASES_DATA = {
            "Salutations & Politesse": [
                { fr: "Bonjour", mg: "Manao ahoana", phonetic: "man-ao a-ho-ana" },
                { fr: "Merci", mg: "Misaotra", phonetic: "mi-sao-tra" },
                { fr: "S'il vous plaît", mg: "Azafady", phonetic: "a-za-fa-dy" },
                { fr: "Excusez-moi", mg: "Miala tsiny", phonetic: "mi-a-la tsi-ny" },
                { fr: "Au revoir", mg: "Veloma", phonetic: "ve-lo-ma" },
                { fr: "Oui", mg: "Eny", phonetic: "e-ny" },
                { fr: "Non", mg: "Tsia", phonetic: "tsi-a" }
            ],
            "Se présenter": [
                { fr: "Je m'appelle...", mg: "[Nom] no anarako", phonetic: "[nom] no a-na-ra-ko" },
                { fr: "Je suis français(e)", mg: "Frantsay aho", phonetic: "fran-tsaï a-ho" },
                { fr: "Je ne parle pas malgache", mg: "Tsy mahay miteny malagasy aho", phonetic: "tsi ma-haï mi-te-ny ma-la-ga-sy a-ho" },
                { fr: "Je suis en vacances", mg: "Miala sasatra aho", phonetic: "mi-a-la sa-sa-tra a-ho" },
                { fr: "Enchanté(e)", mg: "Faly mahafantatra anao", phonetic: "fa-ly ma-ha-fan-ta-tra a-nao" }
            ],
            "Se déplacer": [
                { fr: "Où est la plage ?", mg: "Aiza ny moron-dranomasina ?", phonetic: "aï-za ni mo-ron-dra-no-ma-si-na" },
                { fr: "Combien pour Diego ?", mg: "Hoatrinona ny ho any Antsiranana ?", phonetic: "ho-a-tri-no-na ni ho a-ny an-tsi-ra-na-na" },
                { fr: "Je suis perdu(e)", mg: "Very làlana aho", phonetic: "ve-ry la-la-na a-ho" },
                { fr: "C'est loin ?", mg: "Lavitra ve ?", phonetic: "la-vi-tra ve" },
                { fr: "À droite", mg: "Havanana", phonetic: "ha-va-na-na" },
                { fr: "À gauche", mg: "Havia", phonetic: "hi-vi-a" },
                { fr: "Tout droit", mg: "Mahitsy", phonetic: "ma-hit-sy" },
                { fr: "Arrêtez ici", mg: "Mijanona eto", phonetic: "mi-ja-no-na e-to" }
            ],
            "Négocier & Acheter": [
                { fr: "Combien ça coûte ?", mg: "Ohatrinona ny vidiny ?", phonetic: "o-ha-tri-no-na ni vi-di-ny" },
                { fr: "C'est trop cher", mg: "Lafo be loatra izany", phonetic: "la-fo be lo-a-tra i-za-ny" },
                { fr: "Moins cher possible ?", mg: "Mora kokoa ve ?", phonetic: "mo-ra ko-ko-a ve" },
                { fr: "Je prends ça", mg: "Alako io", phonetic: "a-la-ko i-o" },
                { fr: "Vous acceptez les euros ?", mg: "Mandray euros ve ianao ?", phonetic: "man-draï e-u-ros ve i-a-nao" },
                { fr: "Pas de monnaie", mg: "Tsy misy vola madinika", phonetic: "tsi mi-sy vo-la ma-di-ni-ka" }
            ],
            "Restaurant": [
                { fr: "Une table pour deux", mg: "Latabatra roa azafady", phonetic: "la-ta-ba-tra ro-a a-za-fa-dy" },
                { fr: "Le menu s'il vous plaît", mg: "Ny menu azafady", phonetic: "ni me-nu a-za-fa-dy" },
                { fr: "L'addition", mg: "Ny faktiora", phonetic: "ni fak-ti-o-ra" },
                { fr: "C'était délicieux", mg: "Matsiro be", phonetic: "ma-tsi-ro be" },
                { fr: "Eau minérale", mg: "Rano mineraly", phonetic: "ra-no mi-ne-ra-ly" },
                { fr: "Sans piment", mg: "Tsy misy sakay", phonetic: "tsi mi-sy sa-kaï" },
                { fr: "Je suis végétarien(ne)", mg: "Tsy mihinana hena aho", phonetic: "tsi mi-hi-na-na he-na a-ho" }
            ],
            "Nombres": [
                { fr: "1", mg: "Iray", phonetic: "i-raï" },
                { fr: "2", mg: "Roa", phonetic: "ro-a" },
                { fr: "3", mg: "Telo", phonetic: "te-lo" },
                { fr: "4", mg: "Efatra", phonetic: "e-fa-tra" },
                { fr: "5", mg: "Dimy", phonetic: "di-my" },
                { fr: "10", mg: "Folo", phonetic: "fo-lo" },
                { fr: "100", mg: "Zato", phonetic: "za-to" },
                { fr: "1 000", mg: "Arivo", phonetic: "a-ri-vo" }
            ],
            "Urgence & Santé": [
                { fr: "Aidez-moi !", mg: "Vonjeo aho !", phonetic: "von-je-o a-ho" },
                { fr: "Mal à la tête", mg: "Marary ny lohako", phonetic: "ma-ra-ry ni lo-ha-ko" },
                { fr: "Où est la pharmacie ?", mg: "Aiza ny fivarotam-panafody ?", phonetic: "aï-za ni fi-va-ro-tam-fa-na-fo-dy" },
                { fr: "Hôpital", mg: "Hopitaly", phonetic: "ho-pi-ta-ly" },
                { fr: "J'ai besoin d'un docteur", mg: "Mila dokotera aho", phonetic: "mi-la do-ko-te-ra a-ho" },
                { fr: "Allergie", mg: "Alerizy", phonetic: "a-le-ri-zy" }
            ],
            "Hébergement & Météo": [
                { fr: "Hôtel", mg: "Hotely", phonetic: "ho-te-ly" },
                { fr: "Chambre", mg: "Efitrano", phonetic: "e-fi-tra-no" },
                { fr: "Il fait chaud", mg: "Mafana", phonetic: "ma-fa-na" },
                { fr: "Il pleut", mg: "Avy ny orana", phonetic: "a-vy ni o-ra-na" }
            ]
        };

        const CHECKLIST_ITEMS = [
            "SIM locale Telma",
            "Argent liquide (CB rare)",
            "Adaptateur prise C/E",
            "Crème solaire SPF50+",
            "Lampe frontale",
            "Carnet + stylo",
            "Powerbank 20 000 mAh",
            "Sac étanche",
            "Répulsif anti-moustiques",
            "Trousse premiers secours"
        ];

        // ============================================
        // VARIABLES GLOBALES
        // ============================================

        let map;
        let markersLayer;
        let currentTheme = localStorage.getItem('theme') || 'light';
        let exchangeRate = parseFloat(localStorage.getItem('exchangeRate')) || 4250;
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let checklist = JSON.parse(localStorage.getItem('checklist')) || [];
        let deferredPrompt;

        // ============================================
        // INITIALISATION
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            initData().then(() => {
                initTheme();
                initNavigation();
                initMap();
                initLanguePage();
                initOutilsPage();
                initCityPages();
                initItinerariesPage();
                initSpotsPage();
                initModal();
                initInstallPrompt();
                registerServiceWorker();

                initGeolocation();
            });
        });



        // ============================================
        // GEOLOCALISATION
        // ============================================
        function initGeolocation() {
            const btnLocate = document.getElementById('btnLocateMe');
            if (!btnLocate) return;

            btnLocate.addEventListener('click', () => {
                if ("geolocation" in navigator) {
                    btnLocate.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Localisation...';

                    navigator.geolocation.getCurrentPosition(position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        // Centrer la carte
                        map.setView([lat, lng], 13);

                        // Marqueur utilisateur
                        const userIcon = L.divIcon({
                            className: 'user-marker',
                            html: '<div style="background:#4285F4; width:16px; height:16px; border:3px solid white; border-radius:50%; box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        });

                        L.marker([lat, lng], { icon: userIcon })
                            .addTo(map)
                            .bindPopup("Vous êtes ici !")
                            .openPopup();

                        btnLocate.innerHTML = '<i class="fas fa-check"></i> Trouvé !';
                        setTimeout(() => {
                            btnLocate.innerHTML = '<i class="fas fa-location-crosshairs"></i> Autour de moi';
                        }, 2000);

                    }, error => {
                        alert("Erreur de localisation : " + error.message);
                        btnLocate.innerHTML = '<i class="fas fa-location-crosshairs"></i> Autour de moi';
                    });
                } else {
                    alert("Votre navigateur ne supporte pas la géolocalisation.");
                }
            });
        }


        // ============================================
        // MAP FILTER LOGIC (SMART EXCLUSIVE)
        // ============================================

        const CITY_COORDINATES = {
            'antananarivo': [-18.8792, 47.5079, 12],
            'antsiranana': [-12.2797, 49.2917, 12],
            'mahajanga': [-15.7167, 46.3167, 12],
            'toamasina': [-18.1492, 49.4023, 12],
            'toliara': [-23.3500, 43.6667, 12],
            'fianarantsoa': [-21.4333, 47.0833, 12]
        };

        function toggleFilter(chip, type) {
            const isCity = ['antananarivo', 'antsiranana', 'mahajanga', 'toamasina', 'toliara', 'fianarantsoa'].includes(type);
            // Added budget support
            const isCategory = ['explorer', 'manger', 'dodo', 'sortir', 'spot', 'favorites', 'budget1', 'budget2', 'budget3'].includes(type);

            const checkbox = chip.querySelector('input[type="checkbox"]');
            if (!checkbox) return;

            // 1. SMART CITY LOGIC (Exclusive + Zoom)
            if (isCity) {
                // If clicking a city, uncheck all other cities first
                const allCities = ['antananarivo', 'antsiranana', 'mahajanga', 'toamasina', 'toliara', 'fianarantsoa'];
                allCities.forEach(c => {
                    if (c !== type) {
                        const otherCb = document.getElementById(`filter-${c}`);
                        const otherChip = otherCb ? otherCb.parentElement : null;
                        if (otherCb) {
                            otherCb.checked = false;
                            if (otherChip) otherChip.classList.remove('active');
                        }
                    }
                });

                // Toggle the clicked one
                checkbox.checked = !checkbox.checked;

                // Visual
                if (checkbox.checked) {
                    chip.classList.add('active');
                    // ZOOM TO CITY
                    if (CITY_COORDINATES[type] && map) {
                        map.setView([CITY_COORDINATES[type][0], CITY_COORDINATES[type][1]], CITY_COORDINATES[type][2]);
                    }
                } else {
                    chip.classList.remove('active');
                    if (map) map.setView([-18.766947, 46.869107], 6); // Back to Global
                }
            }

            // 2. SMART CATEGORY LOGIC (Exclusive)
            else if (isCategory) {

                // Uncheck all other categories
                const allCats = ['explorer', 'manger', 'dodo', 'sortir', 'spot', 'favorites'];
                allCats.forEach(c => {
                    if (c !== type) {
                        const otherCb = document.getElementById(`filter-${c}`);
                        const otherChip = otherCb ? otherCb.parentElement : null;
                        if (otherCb) {
                            otherCb.checked = false;
                            if (otherChip) otherChip.classList.remove('active');
                        }
                    }
                });

                // Force Check the clicked one (Exclusive Select)
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    chip.classList.add('active');
                } else {
                    // If already checked, uncheck it -> Show Everything (Empty Filter = All)
                    checkbox.checked = false;
                    chip.classList.remove('active');
                }
            }

            // Update Map
            updateMapMarkers();
        }

        // ============================================
        // GESTION DES FAVORIS
        // ============================================
        function toggleLieuFavorite(id, btnElement, event) {
            if (event) event.stopPropagation(); // Avoid triggering card click
            const index = favorites.indexOf(id);

            if (index === -1) {
                favorites.push(id);
                btnElement.classList.add('active');
                btnElement.innerHTML = '<i class="fa-solid fa-bookmark"></i>';
                showToast("Ajouté aux favoris");
            } else {
                favorites.splice(index, 1);
                btnElement.classList.remove('active');
                btnElement.innerHTML = '<i class="fa-regular fa-bookmark"></i>';
                showToast("Retiré des favoris");
            }

            localStorage.setItem('favorites', JSON.stringify(favorites));
            updateMapMarkers(); // Refresh map to show/hide hearts if needed
        }

        function isFavorite(id) {
            return favorites.includes(id);
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'install-prompt active'; // Reuse existing style
            toast.style.background = 'rgba(0,0,0,0.8)';
            toast.innerHTML = `<span>${message}</span>`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 2000);
        }

        // ============================================
        // THÈME
        // ============================================

        function initTheme() {
            // Restore saved theme
            let savedTheme = localStorage.getItem('theme') || 'light';
            // Apply initial state
            applyTheme(savedTheme);

            const toggleBtn = document.getElementById('themeToggle');
            if (toggleBtn) {
                // Update icon initially
                updateThemeIcon(toggleBtn, savedTheme);

                toggleBtn.addEventListener('click', () => {
                    // Toggle
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    applyTheme(newTheme);
                    updateThemeIcon(toggleBtn, newTheme);
                });
            }
        }

        function applyTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('theme', theme);

            // 1. Data Attribute (for CSS variables)
            document.documentElement.setAttribute('data-theme', theme);

            // 2. Class on BODY & HTML (for color-scheme native controls)
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                document.documentElement.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
                document.documentElement.classList.remove('dark-mode');
            }
        }

        function updateThemeIcon(btn, theme) {
            // Check for icon inside button or button itself
            // Existing code used textContent, newer code uses fontawesome?
            // Let's support both or just fontawesome as per recent tasks
            // Based on previous view, it was toggle.textContent = ... '☀️' : '🌙';
            // But premium design likely uses icons. Let's be safe.
            btn.innerHTML = theme === 'light' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
        }

        // ============================================
        // NAVIGATION
        // ============================================

        function initNavigation() {
            const navBtns = document.querySelectorAll('.nav-btn');
            const shortcuts = document.querySelectorAll('.shortcut-card');

            navBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const page = btn.dataset.page;
                    navigateToPage(page);
                });
            });

            shortcuts.forEach(card => {
                card.addEventListener('click', () => {
                    const page = card.dataset.goto;
                    navigateToPage(page);
                });
            });
        }

        function navigateToPage(pageName) {
            console.log('Navigating to:', pageName);

            // MAPPING DES PAGES VIRTUELLES (REMOVED)
            // 'accueil' and 'explorer' must be treated as independent pages now
            let targetId = pageName;

            // 1. Cacher toutes les sections
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none'; // Force hide
            });

            // 2. Retirer active de tous les boutons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // 3. Afficher la section demandée
            const targetSection = document.getElementById(`page-${targetId}`);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block'; // Force show

                // Hack: Si c'est la carte, forcer le resize pour éviter le gris
                if (targetId === 'carte' && window.map) {
                    setTimeout(() => {
                        window.map.invalidateSize();
                    }, 100);
                }
            } else {
                console.error('Section introuvable:', `page-${targetId}`);
            }

            // 4. Activer le bouton correspondant (sur la page demandée initialement)
            const activeBtn = document.querySelector(`.nav-btn[data-page="${pageName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }

            // 5. Logiciel Spécifique (Filtres auto)
            // 5. Logiciel Spécifique (Nettoyage)
            // (Ancienne logique de simulation de clic supprimée)
            if (pageName === 'accueil') {
                // Reset filters if needed or do nothing
            }
            if (pageName === 'accueil') {
                // Reset filters or ensure "Tout" ? 
                // For now just show map default state (filters are sticky usually)
            }

            // 6. Scroll en haut
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ============================================
        // CARTE
        // ============================================

        function initMap() {
            map = L.map('map').setView([-18.8792, 47.5079], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            markersLayer = L.markerClusterGroup({
                chunkedLoading: true,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true
            });

            // Auto-Center Popup Logic (Smart Pan)
            map.on('popupopen', function (e) {
                const popup = e.popup;
                if (!popup) return;

                // Small delay to ensure layout is computed
                setTimeout(() => {
                    if (popup._container && popup._latlng) {
                        const px = map.project(popup._latlng); // Marker position in pixels
                        const popupHeight = popup._container.clientHeight;

                        // We want the center of the popup to be the center of the screen
                        // Popup is ABOVE the marker. So its center is: MarkerY - (PopupHeight / 2) - (IconHeight aprox 20)
                        px.y -= (popupHeight / 2) + 30;

                        map.panTo(map.unproject(px), { animate: true, duration: 0.5 });
                    }
                }, 10);
            });

            updateMapMarkers();
            map.addLayer(markersLayer);

            // Filtres
            document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateMapMarkers);
            });
        }

        function updateMapMarkers() {
            markersLayer.clearLayers();

            const filters = getActiveFilters();
            const filteredLieux = LIEUX_DATA.filter(lieu => lieu.nom && matchesFilters(lieu, filters));

            filteredLieux.forEach(lieu => {
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: lieu.spotLocal ? '📍' : '📌',
                    iconSize: [32, 32]
                });

                const marker = L.marker([lieu.lat, lieu.lng], { icon });

                const popupContent = `
                    <div class="popup-wrapper">
                        <div class="popup-image-container" style="background-image: url('${lieu.image}');">
                             <button onclick="toggleLieuFavorite(${lieu.id}, this, event)" class="btn-favorite-popup-overlay ${isFavorite(lieu.id) ? 'active' : ''}">
                                ${isFavorite(lieu.id) ? '<i class="fa-solid fa-bookmark"></i>' : '<i class="fa-regular fa-bookmark"></i>'}
                            </button>
                            ${lieu.spotLocal ? '<div class="popup-type-badge" style="background:var(--laterite);">📍 Spot Local</div>' : `<div class="popup-type-badge">${lieu.type}</div>`}
                        </div>
                        <div class="popup-body">
                            <h3 class="popup-title">${lieu.nom}</h3>
                            <div class="popup-subtitle">
                                ${getVilleEmoji(lieu.ville)} ${lieu.ville}
                            </div>
                            
                            <div class="popup-meta">
                                <div class="popup-price">${lieu.prixEur}</div>
                                <div class="popup-rating"><i class="fas fa-star"></i> ${lieu.note}</div>
                            </div>
                            
                            <button onclick="showLieuDetailsByID(${lieu.id})" class="btn-popup-details">
                                Voir détails <i class="fas fa-arrow-right" style="margin-left:6px; font-size:0.8em;"></i>
                            </button>
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent);
                // marker.on('click', () => showLieuDetails(lieu)); // Disabled to prioritize popup

                markersLayer.addLayer(marker);
            });
        }

        /* ============================================
           MAPPING / FILTERS LOGIC
           ============================================ */

        function toggleFilter(element, filterId) {
            const checkbox = document.getElementById('filter-' + filterId);
            if (checkbox) {
                // Si on a cliqué sur le chip (et pas directement la checkbox)
                if (event.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                }

                // Update UI visually
                if (checkbox.checked) {
                    element.classList.add('active');
                } else {
                    element.classList.remove('active');
                }

                updateMapMarkers();
            }
        }

        function getActiveFilters() {
            const filters = {
                provinces: [],
                types: [],
                prix: [],
                favorites: false
            };

            const fav = document.getElementById('filter-favorites');
            if (fav && fav.checked) filters.favorites = true;

            const provinceIds = ['antananarivo', 'antsiranana', 'mahajanga', 'toamasina', 'toliara', 'fianarantsoa'];
            provinceIds.forEach(pid => {
                const cb = document.getElementById(`filter-${pid}`);
                if (cb && cb.checked) {
                    const pNameMap = {
                        'antananarivo': 'Antananarivo',
                        'antsiranana': 'Antsiranana',
                        'mahajanga': 'Mahajanga',
                        'toamasina': 'Toamasina',
                        'toliara': 'Toliara',
                        'fianarantsoa': 'Fianarantsoa'
                    };
                    filters.provinces.push(pNameMap[pid]);
                }
            });

            // NEW CATEGORY LOGIC (HARMONIZED)
            const typeIds = ['explorer', 'manger', 'dodo', 'sortir', 'spot'];
            typeIds.forEach(t => {
                const cb = document.getElementById(`filter-${t}`);
                if (cb && cb.checked) {
                    if (t === 'explorer') {
                        filters.types.push('Incontournable', 'Nature', 'Culture');
                    } else if (t === 'manger') {
                        filters.types.push('Restaurant');
                    } else if (t === 'dodo') {
                        filters.types.push('Hotel', 'Hôtel');
                    } else if (t === 'sortir') {
                        filters.types.push('Sortir', 'Bar', 'Boîte de nuit', 'Club');
                    } else if (t === 'spot') {
                        filters.types.push('Spot Local');
                    }
                }
            });

            // OLD LOGIC SUPPORT (Fallback if needed, or simple cleanup)
            // Added check for old IDs just in case, but standardizing on new ones is better.

            // BUDGET Logic (Extended)
            const budgets = ['budget1', 'budget2', 'budget3'];
            budgets.forEach(b => {
                const cb = document.getElementById(`filter-${b}`);
                if (cb && cb.checked) filters.prix.push(b);
            });

            // Legacy Logic
            const prix = ['gratuit', 'economique', 'moyen'];
            prix.forEach(p => {
                const cb = document.getElementById(`filter-${p}`);
                if (cb && cb.checked) filters.prix.push(p);
            });

            return filters;
        }

        function matchesFilters(lieu, filters) {
            if (filters.favorites && !isFavorite(lieu.id)) return false;

            const lieuProvince = getProvinceForVille(lieu.ville);
            if (filters.provinces.length > 0 && !filters.provinces.includes(lieuProvince)) return false;

            if (filters.types.length > 0) {
                // If filters.types contains 'Spot Local', we must handle the boolean flag
                const lookingForSpot = filters.types.includes('Spot Local');

                // General Type Match
                const typeMatch = filters.types.includes(lieu.type);

                // Specific Spot Match (Boolean or String)
                const spotMatch = lookingForSpot && (lieu.spotLocal === true || lieu.type === 'Spot Local');

                if (!typeMatch && !spotMatch) {
                    return false;
                }
            }

            if (filters.prix.length > 0) {
                const p = lieu.prixNum || 0;
                let match = false;

                // 1. New Budget Logic
                let budget = 'budget2';
                if (p < 20000) budget = 'budget1';
                else if (p < 50000) budget = 'budget2';
                else budget = 'budget3';

                if (filters.prix.includes(budget)) match = true;

                // 2. Legacy Logic
                let prixCat = 'moyen';
                if (p === 0) prixCat = 'gratuit';
                else if (p < 50000) prixCat = 'economique';

                if (filters.prix.includes(prixCat)) match = true;

                if (!match) return false;
            }

            return true;
        }

        // ============================================
        // PAGES VILLES
        // ============================================

        /* ============================================
           PAGES PROVINCES (GÉNÉRATION DYNAMIQUE)
           ============================================ */

        // Mapping Villes -> Provinces
        const COMMUNE_MAPPING = {
            'Antananarivo': 'Antananarivo',
            'Ampefy': 'Antananarivo',
            'Antsirabe': 'Antananarivo',
            'Diego-Suarez': 'Antsiranana',
            'Nosy Be': 'Antsiranana',
            'Ankarana': 'Antsiranana',
            'Ambanja': 'Antsiranana',
            'Montagne d\'Ambre': 'Antsiranana',
            'Anivorano': 'Antsiranana',
            'Mahajanga': 'Mahajanga',
            'Andasibe': 'Toamasina',
            'Mananara': 'Toamasina',
            'Sainte-Marie': 'Toamasina',
            'Isalo': 'Toliara',
            'Ifaty': 'Toliara',
            'Anakao': 'Toliara',
            'Tuléar': 'Toliara',
            'Toliara': 'Toliara',
            'Fianarantsoa': 'Fianarantsoa'
        };

        const PROVINCE_CONFIG = {
            'Antananarivo': { emoji: '<i class="fa-solid fa-landmark"></i>', name: 'Antananarivo', desc: 'La capitale et les hautes terres' },
            'Antsiranana': { emoji: '<i class="fa-solid fa-anchor"></i>', name: 'Antsiranana (Nord)', desc: 'Diego, Nosy Be et merveilles du Nord' },
            'Fianarantsoa': { emoji: '<i class="fa-solid fa-train"></i>', name: 'Fianarantsoa', desc: 'Le sud des hautes terres et le train' },
            'Mahajanga': { emoji: '<i class="fa-solid fa-umbrella-beach"></i>', name: 'Mahajanga (Ouest)', desc: 'Boeny, baobabs et grottes' },
            'Toamasina': { emoji: '<i class="fa-solid fa-ship"></i>', name: 'Toamasina (Est)', desc: 'L\'Est sauvage, l\'Indri et les lagons' },
            'Toliara': { emoji: '<i class="fa-solid fa-sun"></i>', name: 'Toliara (Sud)', desc: 'Le grand Sud, le désert et le lagon' }
        };

        function getProvinceForVille(villeName) {
            return COMMUNE_MAPPING[villeName] || 'Autre';
        }

        function updatePremiumInfo(city, provinceKey) {
            const container = document.getElementById(`premium-container-${provinceKey}`);
            if (!container) return;

            // Only update if we have data for this city
            const zoneData = window.ZONES_DATA && window.ZONES_DATA[city];
            if (!zoneData) {
                container.innerHTML = '';
                return;
            }

            let html = '';

            // 1. LOGISTIQUE (Accordion)
            if (zoneData.logistique) {
                const { route_etat, transport_conseil } = zoneData.logistique;
                const { description_fun } = zoneData.infos || {};

                html += `
                    <div class="logistique-container">
                        <div class="logistique-header" onclick="this.nextElementSibling.classList.toggle('active'); this.querySelector('.fa-chevron-down').classList.toggle('fa-chevron-up');">
                            <h3><i class="fas fa-truck-monster" style="color:#D4AF37; margin-right:10px;"></i> Logistique "Brousse" (${city})</h3>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="logistique-content">
                            <div class="logistique-item">
                                <div class="logistique-label">L'avis Grok</div>
                                <div class="logistique-text">"${description_fun || 'Pas de commentaire.'}"</div>
                            </div>
                            <div class="logistique-item">
                                <div class="logistique-label">État de la Route</div>
                                <div class="logistique-text">${route_etat}</div>
                            </div>
                            <div class="logistique-item">
                                <div class="logistique-label">Conseil Transport</div>
                                <div class="logistique-text">${transport_conseil}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 2. GASTRONOMIE (Highlights)
            if (window.LIEUX_DATA) {
                const restos = window.LIEUX_DATA
                    .filter(l => l.ville === city && l.type === 'Restaurant' && l.note >= 4.7)
                    .sort((a, b) => b.note - a.note)
                    .slice(0, 3);

                if (restos.length > 0) {
                    html += `<div class="gastro-section">
                        <h3 style="margin-bottom:15px; font-family:'Playfair Display', serif; color:var(--text-primary);"><i class="fas fa-star" style="color:#D4AF37;"></i> Nos Pépites Gourmandes</h3>
                        <div class="gastro-grid">`;
                    restos.forEach(resto => {
                        html += `
                            <div class="gastro-card">
                                <div class="gastro-image" style="background-image: url('${resto.image}')">
                                    <span class="gastro-badge">${resto.note}</span>
                                </div>
                                <div class="gastro-details">
                                    <h4 class="gastro-title">${resto.nom}</h4>
                                    <p class="gastro-desc" style="font-size:0.85rem; margin-bottom:0.5rem;">${resto.description.substring(0, 80)}...</p>
                                    <div class="gastro-footer">
                                         <span class="gastro-price">${resto.prix}</span>
                                         <button class="btn-text" onclick="showLieuDetailsByID(${resto.id})" style="color:var(--laterite); background:none; border:none; font-weight:600; cursor:pointer;">Voir</button>
                                    </div>
                                </div>
                            </div>
                         `;
                    });
                    html += `</div></div>`;
                }
            }

            container.innerHTML = html;
        }

        function initCityPages() {
            // Group data by Province
            const locationsByProvince = {};

            Object.keys(PROVINCE_CONFIG).forEach(p => locationsByProvince[p] = []);

            LIEUX_DATA.forEach(lieu => {
                const prov = getProvinceForVille(lieu.ville);
                if (locationsByProvince[prov]) {
                    locationsByProvince[prov].push(lieu);
                }
            });

            // Generate Content for each Province
            Object.keys(locationsByProvince).forEach(provinceKey => {
                const container = document.getElementById(`page-${provinceKey.toLowerCase()}`);
                if (!container) return;

                const config = PROVINCE_CONFIG[provinceKey];
                const lieux = locationsByProvince[provinceKey];

                let cityFiltersHTML = '';
                let defaultCityState = 'all';

                // PREMIUM SWITCHER FOR ANTSIRANANA
                if (provinceKey === 'Antsiranana') {
                    defaultCityState = 'Diego-Suarez'; // Force default to Diego
                    cityFiltersHTML = `
                        <div class="segmented-control-container">
                            <div class="segmented-control">
                                <button class="segment-btn active" onclick="filterCity('Diego-Suarez', this)">Diego-Suarez</button>
                                <button class="segment-btn" onclick="filterCity('Nosy Be', this)">Nosy Be</button>
                            </div>
                        </div>
                    `;
                }

                // Determine default city for Premium Info
                let premiumDefaultCity = defaultCityState === 'all' ? config.name.split(' ')[0] : defaultCityState;
                if (provinceKey === 'Antananarivo') premiumDefaultCity = 'Antananarivo';
                if (provinceKey === 'Toamasina') premiumDefaultCity = 'Toamasina';
                if (provinceKey === 'Mahajanga') premiumDefaultCity = 'Mahajanga';
                if (provinceKey === 'Toliara') premiumDefaultCity = 'Toliara';


                let html = `
                    <div class="city-header">
                        <div class="banner-content">
                            <h2 class="city-title">${config.emoji} ${config.name}</h2>
                            <p class="city-desc">${config.desc}</p>
                        </div>
                    </div>
                    
                    ${cityFiltersHTML}

                    <!-- PREMIUM SECTION CONTAINER (Split for Accordions) -->
                    <div id="logistique-container-${provinceKey}" class="premium-zone-info"></div>
                    <div id="gastronomie-container-${provinceKey}" class="premium-zone-info"></div>

                    <div class="nav-pills" style="margin-bottom: 20px; padding-bottom: 5px; display: flex; align-items: center; justify-content: space-between; overflow-x: auto;">
                        <!-- Group 1: Categories -->
                        <div style="display: flex; gap: 8px;">
                            <button class="nav-pill active" onclick="filterProvinceItems('all', '${provinceKey}', this)"><i class="fa-solid fa-layer-group"></i> Tout</button>
                            <button class="nav-pill" onclick="filterProvinceItems('explorer', '${provinceKey}', this)"><i class="fa-solid fa-binoculars"></i> Explorer</button>
                            <button class="nav-pill" onclick="filterProvinceItems('manger', '${provinceKey}', this)"><i class="fa-solid fa-utensils"></i> Manger</button>
                            <button class="nav-pill" onclick="filterProvinceItems('dodo', '${provinceKey}', this)"><i class="fa-solid fa-bed"></i> Dormir</button>
                            <button class="nav-pill" onclick="filterProvinceItems('sortir', '${provinceKey}', this)"><i class="fa-solid fa-martini-glass-citrus"></i> Sortir</button>
                            <button class="nav-pill" onclick="filterProvinceItems('spot', '${provinceKey}', this)"><i class="fa-solid fa-map-pin"></i> Spots</button>
                        </div>
                        
                        <!-- Group 2: Budget (Pushed to Right via justify-content: space-between) -->
                        <div style="display: flex; gap: 8px; margin-left: 20px;">
                            <button class="nav-pill" onclick="toggleProvinceBudget('low', '${provinceKey}', this)">€</button>
                            <button class="nav-pill" onclick="toggleProvinceBudget('mid', '${provinceKey}', this)">€€</button>
                            <button class="nav-pill" onclick="toggleProvinceBudget('high', '${provinceKey}', this)">€€€</button>
                        </div>
                    </div>

                    <div class="lieux-grid" id="grid-${provinceKey}" data-current-city="${defaultCityState}">
                `;

                if (lieux.length === 0) {
                    html += `<p style="text-align:center; color:var(--text-secondary); grid-column:1/-1;">Aucun lieu pour le moment.</p>`;
                } else {
                    lieux.forEach(lieu => {
                        html += createLieuCard(lieu);
                    });
                }

                html += `</div>`;
                container.innerHTML = html;

                // Init Premium Info via renderPremiumUI (from app-data.js)
                setTimeout(() => {
                    if (window.renderPremiumUI) {
                        window.renderPremiumUI(premiumDefaultCity, provinceKey); // Pass provinceKey for ID scoping
                    }
                }, 100); // 100ms delay to ensure DOM is painted
            });
        }

        // Global State for Province Filters
        window.PROVINCE_STATES = window.PROVINCE_STATES || {};

        function getProvinceState(key) {
            if (!window.PROVINCE_STATES[key]) {
                window.PROVINCE_STATES[key] = { category: 'all', budget: null };
            }
            return window.PROVINCE_STATES[key];
        }

        // Budget Helper (Matches createLieuCard logic)
        function calculateBudgetLevel(priceString, type) {
            if (!priceString) return 'low';
            const num = parseInt(priceString.replace(/\D/g, '')) || 0;
            const isResto = ['Restaurant', 'Bar', 'Snack'].includes(type);
            if (isResto) {
                if (num > 50000) return 'high';
                if (num > 20000) return 'mid';
                return 'low';
            } else {
                if (num > 180000) return 'high';
                if (num > 60000) return 'mid';
                return 'low';
            }
        }

        window.toggleProvinceBudget = function (level, provinceKey, btn) {
            const state = getProvinceState(provinceKey);
            // Toggle Logic
            if (state.budget === level) {
                state.budget = null; // Deselect
            } else {
                state.budget = level;
            }
            applyProvinceFilters(provinceKey);
        };

        window.filterProvinceItems = function (category, provinceKey, btn) {
            const state = getProvinceState(provinceKey);
            state.category = category;
            applyProvinceFilters(provinceKey);
        };

        window.applyProvinceFilters = function (provinceKey) {
            const state = getProvinceState(provinceKey);
            const container = document.getElementById(`page-${provinceKey.toLowerCase()}`);
            if (!container) return;

            // Update UI - Categories (Separate from Budget Buttons)
            const catButtons = container.querySelectorAll('.nav-pill:not([onclick*="toggleProvinceBudget"])');
            catButtons.forEach(b => {
                // heuristic: active if onclick contains state.category
                // or simpler: just check category arg in onclick? 
                // We'll trust the button reference isn't kept, so we check attribute
                const fnCall = b.getAttribute('onclick');
                if (fnCall && fnCall.includes(`'${state.category}'`)) b.classList.add('active');
                else b.classList.remove('active');
            });

            // Update UI - Budget
            const budgetButtons = container.querySelectorAll('.nav-pill[onclick*="toggleProvinceBudget"]');
            budgetButtons.forEach(b => {
                const fnCall = b.getAttribute('onclick');
                if (state.budget && fnCall && fnCall.includes(`'${state.budget}'`)) b.classList.add('active');
                else b.classList.remove('active');
            });


            const grid = document.getElementById(`grid-${provinceKey}`);
            let currentCity = 'all';
            if (grid.dataset.currentCity) currentCity = grid.dataset.currentCity;

            // Filter Logic
            let provinceLieux = LIEUX_DATA.filter(l => getProvinceForVille(l.ville) === provinceKey);

            // City
            if (currentCity !== 'all') {
                provinceLieux = provinceLieux.filter(l => l.ville === currentCity);
            }

            // Category
            let filtered = [];
            if (state.category === 'all') {
                filtered = provinceLieux;
            } else if (state.category === 'explorer') {
                filtered = provinceLieux.filter(l => ['Incontournable', 'Nature', 'Culture'].includes(l.type));
            } else if (state.category === 'manger') {
                filtered = provinceLieux.filter(l => l.type === 'Restaurant');
            } else if (state.category === 'dodo') {
                filtered = provinceLieux.filter(l => ['Hotel', 'Hôtel'].includes(l.type));
            } else if (state.category === 'sortir') {
                filtered = provinceLieux.filter(l => ['Bar', 'Boîte de nuit', 'Sortir', 'Club'].includes(l.type));
            } else if (state.category === 'spot') {
                filtered = provinceLieux.filter(l => l.spotLocal === true || l.type === 'Spot Local');
            }

            // Budget
            if (state.budget) {
                filtered = filtered.filter(l => calculateBudgetLevel(l.prix, l.type) === state.budget);
            }

            // Render
            if (filtered.length === 0) {
                grid.innerHTML = `<p style="text-align:center; color:var(--text-secondary); grid-column:1/-1;">Aucun lieu pour ce filtre.</p>`;
            } else {
                grid.innerHTML = filtered.map(l => createLieuCard(l)).join('');
            }
        };

        window.filterCity = function (city, btn) {
            // Update buttons style (Premium Segmented Control Logic)
            const container = btn.parentElement;
            container.querySelectorAll('.segment-btn').forEach(b => {
                b.classList.remove('active');
            });
            btn.classList.add('active');

            // Update Grid Data Attribute
            const grid = document.getElementById('grid-Antsiranana');
            if (grid) {
                grid.dataset.currentCity = city;
                // Re-trigger current category filter to apply city context
                const activeCategoryBtn = grid.parentElement.querySelector('.nav-pill.active');
                if (activeCategoryBtn) activeCategoryBtn.click();
            }

            // UPDATE PREMIUM INFO
            updatePremiumInfo(city, 'Antsiranana');
        };

        // Old filter function removed
        window.filterCityItems = function () { }; // No-op


        // ============================================
        // MODAL DETAILS LOGIC
        // ============================================

        window.showLieuDetailsByID = function (id) {
            const lieu = LIEUX_DATA.find(l => l.id == id);
            if (lieu) {
                showLieuDetails(lieu);
            } else {
                console.error('Lieu introuvable ID:', id);
            }
        };

        window.showLieuDetails = function (lieu) {
            const modal = document.getElementById('lieuModal');
            if (!modal) return;

            // Populate Modal
            document.getElementById('modal-image').src = lieu.image || 'images/placeholders/default.jpg';
            document.getElementById('modal-type').textContent = lieu.type;

            // Spot Local Badge Logic
            const badgeType = document.getElementById('modal-type');
            if (lieu.spotLocal) {
                badgeType.style.background = 'var(--laterite)';
                badgeType.textContent = 'Spot Local 📍';
            } else {
                badgeType.style.background = 'rgba(0,0,0,0.7)';
                badgeType.textContent = lieu.type;
            }

            document.getElementById('modal-title').textContent = lieu.nom;
            document.getElementById('modal-desc').innerHTML = lieu.description; // Allow HTML in desc

            // Meta Info
            document.getElementById('modal-price').textContent = lieu.prix;
            document.getElementById('modal-duration').textContent = lieu.duree || 'Durée libre';
            document.getElementById('modal-access').textContent = lieu.acces || 'Accès standard';

            // Advice Section
            const adviceSection = document.getElementById('modal-advice-section');
            if (lieu.conseil) {
                adviceSection.style.display = 'block';
                document.getElementById('modal-advice').textContent = lieu.conseil;
            } else {
                adviceSection.style.display = 'none';
            }

            // External Link
            const linkBtn = document.getElementById('modal-link-btn');
            if (lieu.siteWeb) {
                linkBtn.style.display = 'inline-flex';
                linkBtn.onclick = () => window.open(lieu.siteWeb, '_blank');
            } else {
                linkBtn.style.display = 'none';
            }

            // Open Modal
            // modal.style.display = 'block'; // Faux: Casse le flexbox centering
            modal.classList.add('active'); // Correct: Utilise la classe CSS avec display: flex

            // Close Handler
            const closeBtn = modal.querySelector('.close-modal');
            closeBtn.onclick = () => {
                modal.classList.remove('active');
            };

            // Click outside to close
            window.onclick = (event) => {
                if (event.target == modal) {
                    modal.classList.remove('active');
                }
            };
        };

        function getVilleEmoji(ville) {
            const emojis = {
                'Antananarivo': '🏛️',
                'Diego-Suarez': '🏝️',
                'Nosy Be': '🌴',
                'Mahajanga': '🌊',
                'Andasibe': '🌿',
                'Isalo': '🏜️',
                'Ifaty': '🏖️',
                'Ankarana': '🕳️',
                'Mananara': '🐊'
            };
            return emojis[ville] || '📍';
        }

        function createLieuCard(lieu, category = '') {
            const prixClass = lieu.prixNum === 0 ? 'gratuit' : lieu.prixNum < 10000 ? 'abordable' : 'premium';

            return `
                <article class="lieu-card" data-id="${lieu.id}" data-category="${category}" style="position: relative; cursor: pointer;">
                    <button onclick="toggleLieuFavorite(${lieu.id}, this, event)" class="btn-favorite ${isFavorite(lieu.id) ? 'active' : ''}">
                        ${isFavorite(lieu.id) ? '<i class="fa-solid fa-bookmark"></i>' : '<i class="fa-regular fa-bookmark"></i>'}
                    </button>
                    <img src="${lieu.image}" alt="${lieu.nom}" class="lieu-image" loading="lazy">
                    <div class="lieu-content">
                        <div class="lieu-header">
                            <h3 class="lieu-title">${lieu.nom}</h3>
                            ${lieu.spotLocal ? '<span class="badge-spot">📍 Spot Local</span>' : `<span class="badge-type">${lieu.type}</span>`}
                        </div>
                        <div class="lieu-meta">
                            <span class="lieu-prix ${prixClass}">${lieu.prix}</span>
                            <span class="lieu-note">⭐ ${lieu.note}</span>
                        </div>
                        <p class="lieu-desc">${lieu.description}</p>
                        <button class="btn-details" data-lieu-id="${lieu.id}">Voir détails</button>
                    </div>
                </article>
            `;
        }

        // ============================================
        // PAGE SPOTS LOCAUX
        // ============================================

        function initSpotsPage() {
            const spotsContainer = document.getElementById('spotsContainer');
            const spots = LIEUX_DATA.filter(l => l.spotLocal && l.nom);

            spotsContainer.innerHTML = spots.map(lieu => createLieuCard(lieu)).join('');

            spotsContainer.querySelectorAll('.btn-details').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const lieuId = parseInt(e.target.dataset.lieuId);
                    const lieu = LIEUX_DATA.find(l => l.id === lieuId);
                    if (lieu) showLieuDetails(lieu);
                });
            });
        }

        // ============================================
        // MODAL
        // ============================================

        function initModal() {
            const modal = document.getElementById('modal');
            const closeBtn = document.getElementById('modalClose');

            closeBtn.addEventListener('click', () => {
                modal.classList.remove('active');
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
            // Event Delegation pour ouvrir la modale au clic sur une carte
            document.addEventListener('click', (e) => {
                // Ignorer si on clique sur le bouton favori
                if (e.target.closest('.btn-favorite')) return;

                const card = e.target.closest('.lieu-card');
                // Gestion aussi du clic sur le bouton "Voir détails" spécifique
                const btnDetails = e.target.closest('.btn-details');

                if (card || btnDetails) {
                    const target = card || btnDetails.closest('.lieu-card');
                    if (target) {
                        const id = parseInt(target.dataset.id);
                        if (!isNaN(id)) openModal(id);
                    }
                }
            });
        }

        function openModal(id) {
            const lieu = LIEUX_DATA.find(l => l.id === id);
            if (!lieu) return;

            const modal = document.getElementById('modal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalTitle');
            const modalBadges = document.getElementById('modalBadges');
            const modalInfoGrid = document.getElementById('modalInfoGrid');
            const modalSections = document.getElementById('modalSections');

            // Reset Scroll
            if (modal.querySelector('.popup-content')) modal.querySelector('.popup-content').scrollTop = 0;

            modalImage.src = lieu.image;
            modalImage.alt = lieu.nom;
            modalTitle.textContent = lieu.nom;

            // Badges
            let badgesHTML = '';
            if (lieu.spotLocal) {
                badgesHTML += '<span class="badge-spot">📍 Spot Local</span> ';
            }
            badgesHTML += `<span class="badge-type">${lieu.type}</span>`;
            modalBadges.innerHTML = badgesHTML;

            // Infos grille
            modalInfoGrid.innerHTML = `
                <div class="modal-info-item">
                    <div class="modal-info-label">Ville</div>
                    <div class="modal-info-value">${lieu.ville}</div>
                </div>
                <div class="modal-info-item">
                    <div class="modal-info-label">Prix</div>
                    <div class="modal-info-value">${lieu.prix}</div>
                </div>
                <div class="modal-info-item">
                    <div class="modal-info-label">Note</div>
                    <div class="modal-info-value">⭐ ${lieu.note}</div>
                </div>
                ${lieu.duree ? `
                <div class="modal-info-item">
                    <div class="modal-info-label">Durée</div>
                    <div class="modal-info-value">⏱️ ${lieu.duree}</div>
                </div>` : ''}
            `;

            // Sections
            let sectionsHTML = `
                <div class="modal-section">
                    <div class="modal-section-title">Description</div>
                    <div class="modal-section-content" style="line-height: 1.6;">${lieu.description}</div>
                </div>
                ${lieu.conseil ? `
                <div class="modal-section" style="background: rgba(255, 215, 0, 0.1); border-left: 3px solid #FFD700; padding: 10px;">
                    <div class="modal-section-title" style="color: #FFD700;">💡 Conseil du Local</div>
                    <div class="modal-section-content">${lieu.conseil}</div>
                </div>` : ''}
                <div class="modal-section">
                    <div class="modal-section-title">Accès</div>
                    <div class="modal-section-content">${lieu.acces}</div>
                </div>
                ${lieu.siteWeb ? `<a href="${lieu.siteWeb}" target="_blank" class="btn-website">🌍 Visiter le site web</a>` : ''}
            `;

            if (lieu.horaires) {
                sectionsHTML += `
                    <div class="modal-section">
                        <div class="modal-section-title">Horaires</div>
                        <div class="modal-section-content">${lieu.horaires}</div>
                    </div>
                `;
            }

            if (lieu.contactLocal) {
                sectionsHTML += `
                    <div class="modal-section">
                        <div class="modal-section-title">Contact Local</div>
                        <div class="modal-section-content">${lieu.contactLocal}</div>
                    </div>
                `;
            }

            if (lieu.respect) {
                sectionsHTML += `
                    <div class="modal-section">
                        <div class="modal-section-title">⚠️ Respect Requis</div>
                        <div class="modal-section-content">${lieu.respect}</div>
                    </div>
                `;
            }

            modalSections.innerHTML = sectionsHTML;

            // Gestion du bouton favori dans la modale
            const favBtn = document.querySelector('.btn-favorite-popup-overlay');
            if (favBtn) {
                favBtn.classList.remove('active');
                favBtn.innerHTML = '<i class="fa-regular fa-bookmark"></i>';

                if (isFavorite(lieu.id)) {
                    favBtn.classList.add('active');
                    favBtn.innerHTML = '<i class="fa-solid fa-bookmark"></i>';
                }

                // Recreation du bouton pour clean les listeners
                const newFavBtn = favBtn.cloneNode(true);
                favBtn.parentNode.replaceChild(newFavBtn, favBtn);
                newFavBtn.onclick = (e) => toggleLieuFavorite(lieu.id, newFavBtn, e);
            }

            modal.classList.add('active');
        }

        // ============================================
        // PAGE LANGUE
        // ============================================

        function initLanguePage() {
            const container = document.getElementById('accordionContainer');
            const searchInput = document.getElementById('langueSearch');

            Object.keys(PHRASES_DATA).forEach((category, index) => {
                const accordionHTML = createAccordion(category, PHRASES_DATA[category], index);
                container.insertAdjacentHTML('beforeend', accordionHTML);
            });

            // Event listeners accordéons
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    const item = header.parentElement;
                    const wasOpen = item.classList.contains('open');

                    // Fermer tous
                    document.querySelectorAll('.accordion-item').forEach(i => i.classList.remove('open'));

                    // Ouvrir celui-ci si fermé
                    if (!wasOpen) {
                        item.classList.add('open');
                    }
                });
            });

            // Recherche
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                document.querySelectorAll('.phrase-item').forEach(item => {
                    const fr = item.querySelector('.phrase-fr').textContent.toLowerCase();
                    const mg = item.querySelector('.phrase-mg').textContent.toLowerCase();
                    if (fr.includes(query) || mg.includes(query)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });

            // Boutons actions phrases
            container.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-audio')) {
                    playAudio(e.target.dataset.mg, e.target.dataset.fr);
                } else if (e.target.classList.contains('btn-copy')) {
                    copyToClipboard(e.target.dataset.text);
                } else if (e.target.classList.contains('btn-favorite')) {
                    toggleExpressionFavorite(e.target);
                }
            });
        }

        function createAccordion(category, phrases, index) {
            const phrasesHTML = phrases.map((phrase, i) => `
                <div class="phrase-item">
                    <div class="phrase-content">
                        <div class="phrase-fr">${phrase.fr}</div>
                        <div class="phrase-mg">${phrase.mg}</div>
                        <div class="phrase-phonetic">(${phrase.phonetic})</div>
                    </div>
                    <div class="phrase-actions">
                        <button class="btn-icon btn-audio" data-mg="${phrase.mg}" data-fr="${phrase.fr}" title="Écouter">🔊</button>
                        <button class="btn-icon btn-copy" data-text="${phrase.mg}" title="Copier">📋</button>
                        <button class="btn-icon btn-favorite ${favorites.includes(`${category}-${i}`) ? 'active' : ''}" data-category="${category}" data-index="${i}" title="Favori">⭐</button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="accordion-item ${index === 0 ? 'open' : ''}">
                    <div class="accordion-header">
                        <h3 class="accordion-title">
                            ${getCategoryEmoji(category)} ${category}
                        </h3>
                        <span class="accordion-icon">▼</span>
                    </div>
                    <div class="accordion-body">
                        <div class="accordion-content">
                            ${phrasesHTML}
                        </div>
                    </div>
                </div>
            `;
        }

        function getCategoryEmoji(category) {
            const emojis = {
                "Salutations & Politesse": "👋",
                "Se présenter": "🙋",
                "Se déplacer": "🚶",
                "Négocier & Acheter": "💰",
                "Restaurant": "🍽️",
                "Nombres": "🔢",
                "Urgence & Santé": "🚨",
                "Hébergement & Météo": "hotel"
            };
            return emojis[category] || "💬";
        }

        function playAudio(textMg, textFr) {
            // Tentative de lecture du fichier audio généré
            if (textFr) {
                const filename = slugify(textFr) + '.wav';
                const audio = new Audio('audio/' + filename);

                audio.play().catch(err => {
                    console.warn('Fichier audio introuvable, fallback sur TTS', err);
                    speakFallback(textMg);
                });
            } else {
                speakFallback(textMg);
            }
        }

        function speakFallback(text) {
            // Simulation audio (Speech Synthesis API)
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'mg-MG'; // Peu de support navigateur mais mieux que rien
            utterance.rate = 0.8;
            window.speechSynthesis.speak(utterance);
        }

        function slugify(text) {
            return text
                .toString()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase()
                .trim()
                .replace(/[^\w\s-]/g, '')
                .replace(/[\s_-]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Feedback visuel
                alert('Copié dans le presse-papiers !');
            });
        }

        function toggleExpressionFavorite(btn) {
            const key = `${btn.dataset.category}-${btn.dataset.index}`;
            const index = favorites.indexOf(key);

            if (index > -1) {
                favorites.splice(index, 1);
                btn.classList.remove('active');
            } else {
                favorites.push(key);
                btn.classList.add('active');
            }

            localStorage.setItem('favorites', JSON.stringify(favorites));
        }

        // ============================================
        // PAGE OUTILS
        // ============================================

        function initOutilsPage() {
            // --- CONVERTISSEUR AVANCÉ ---
            const state = {
                rates: JSON.parse(localStorage.getItem('currencyRates')) || { EUR: 4800, USD: 4500, GBP: 5700, CHF: 5000, ZAR: 250 },
                currency: localStorage.getItem('selectedCurrency') || 'EUR',
                mode: localStorage.getItem('converterMode') || 'AUTO', // 'AUTO' or 'MANUAL'
                lastUpdate: localStorage.getItem('ratesLastUpdate') || null,
                isInverted: false
            };

            const currencySymbols = { EUR: '€', USD: '$', GBP: '£', CHF: 'Fr', ZAR: 'R' };

            // Elements
            const selector = document.getElementById('currencySelector');
            const btnRefresh = document.getElementById('btnRefreshRate');
            const statusBadge = document.getElementById('converterStatus');
            const inputForeign = document.getElementById('inputForeign');
            const inputLocal = document.getElementById('inputLocal'); // Ar input
            const foreignLabel = document.getElementById('foreignLabel');
            const rateText = document.getElementById('rateText');
            const btnEdit = document.getElementById('btnEditRate');
            const btnInvert = document.getElementById('btnInvert');
            const container = document.getElementById('converterInputsContainer');
            const rowForeign = document.getElementById('rowForeign');
            const rowLocal = document.getElementById('rowLocal');

            // Init UI
            selector.value = state.currency;
            updateUI();

            // Auto-fetch if old data (> 24h) and online
            if (navigator.onLine && state.mode === 'AUTO') {
                const now = Date.now();
                if (!state.lastUpdate || (now - state.lastUpdate > 86400000)) {
                    fetchRates();
                }
            }

            // --- LISTENERS ---

            selector.addEventListener('change', (e) => {
                state.currency = e.target.value;
                localStorage.setItem('selectedCurrency', state.currency);
                updateUI();
                recalcFromForeign();
            });

            btnRefresh.addEventListener('click', () => {
                state.mode = 'AUTO';
                localStorage.setItem('converterMode', 'AUTO');
                fetchRates();
            });

            btnEdit.addEventListener('click', () => {
                const currentRate = state.rates[state.currency];
                const newRate = prompt(`Entrez votre taux manuel pour 1 ${state.currency} :`, currentRate);
                if (newRate && !isNaN(newRate)) {
                    state.rates[state.currency] = parseFloat(newRate);
                    state.mode = 'MANUAL';
                    saveState();
                    updateUI();
                    recalcFromForeign();
                }
            });

            btnInvert.addEventListener('click', () => {
                state.isInverted = !state.isInverted;
                // Swap DOM elements
                if (state.isInverted) {
                    container.insertBefore(rowLocal, rowForeign); // Ar on top
                    btnInvert.style.transform = "rotate(270deg)";
                } else {
                    container.insertBefore(rowForeign, rowLocal); // Foreign on top
                    btnInvert.style.transform = "rotate(90deg)";
                }
            });

            inputForeign.addEventListener('input', recalcFromForeign);
            inputLocal.addEventListener('input', recalcFromLocal);

            // --- FUNCTIONS ---

            function fetchRates() {
                btnRefresh.classList.add('fa-spin'); // Animation

                // API Gratuite (Open Exchange Rates fallback or similar free json)
                // Ici on utilise open.er-api.com qui est gratuit et stable
                fetch('https://open.er-api.com/v6/latest/EUR')
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.rates && data.rates.MGA) {
                            const eurToMga = data.rates.MGA;

                            // Déduire les autres par cross-calculation si l'API est base EUR
                            // (ou fetcher chaque, mais cross-calc suffit pour estimation)
                            const rates = {
                                EUR: eurToMga,
                                USD: eurToMga / data.rates.USD,
                                GBP: eurToMga / data.rates.GBP,
                                CHF: eurToMga / data.rates.CHF,
                                ZAR: eurToMga / data.rates.ZAR
                            };

                            // Arrondir
                            Object.keys(rates).forEach(k => rates[k] = Math.round(rates[k]));

                            state.rates = rates;
                            state.lastUpdate = Date.now();
                            state.mode = 'AUTO';
                            saveState();
                            updateUI();
                            recalcFromForeign();

                            showToast('Taux mis à jour avec succès !');
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        showToast('Erreur connexion. Vérifiez internet.');
                    })
                    .finally(() => {
                        btnRefresh.classList.remove('fa-spin');
                    });
            }

            function updateUI() {
                const rate = Math.round(state.rates[state.currency]);
                const symbol = currencySymbols[state.currency];

                foreignLabel.textContent = symbol;
                rateText.textContent = `1 ${symbol} = ${rate} Ar`;

                // Afficher date maj
                if (state.lastUpdate) {
                    const date = new Date(parseInt(state.lastUpdate));
                    const dateStr = `${date.getDate()}/${date.getMonth() + 1} ${date.getHours()}h${date.getMinutes().toString().padStart(2, '0')}`;
                    rateText.textContent += ` (Maj: ${dateStr})`;
                }

                if (state.mode === 'AUTO') {
                    statusBadge.textContent = "🟢 Taux Réel";
                    statusBadge.className = "status-badge live";
                    statusBadge.title = "Taux officiel via internet";
                } else {
                    statusBadge.textContent = "🔴 Mode Manuel";
                    statusBadge.className = "status-badge manual";
                    statusBadge.title = "Taux défini par l'utilisateur";
                }
            }

            function recalcFromForeign() {
                const val = parseFloat(inputForeign.value) || 0;
                const rate = state.rates[state.currency];
                inputLocal.value = Math.round(val * rate);
            }

            function recalcFromLocal() {
                const val = parseFloat(inputLocal.value) || 0;
                const rate = state.rates[state.currency];
                inputForeign.value = (val / rate).toFixed(2);
            }

            function saveState() {
                localStorage.setItem('currencyRates', JSON.stringify(state.rates));
                localStorage.setItem('converterMode', state.mode);
                if (state.lastUpdate) localStorage.setItem('ratesLastUpdate', state.lastUpdate);
            }

            // --- CHECKLIST EXISTANTE (Code inchangé) ---
            const checklistContainer = document.getElementById('checklistContainer');

            CHECKLIST_ITEMS.forEach((item, index) => {
                const checked = checklist.includes(index);
                const html = `
                    <div class="checklist-item ${checked ? 'checked' : ''}" data-index="${index}">
                        <div class="checklist-checkbox"></div>
                        <span class="checklist-label">${item}</span>
                    </div>
                `;
                checklistContainer.insertAdjacentHTML('beforeend', html);
            });

            checklistContainer.addEventListener('click', (e) => {
                const item = e.target.closest('.checklist-item');
                if (!item) return;

                const index = parseInt(item.dataset.index);
                const checklistIndex = checklist.indexOf(index);

                if (checklistIndex > -1) {
                    checklist.splice(checklistIndex, 1);
                    item.classList.remove('checked');
                } else {
                    checklist.push(index);
                    item.classList.add('checked');
                }
                localStorage.setItem('checklist', JSON.stringify(checklist));
            });

            // --- OUTIL TAXI BROUSSE (PREMIUM MULTI-TIER) ---
            const btnCalcTaxi = document.getElementById('btnCalcTaxi');
            if (btnCalcTaxi) {
                // DONNÉES REFERENCE (2024/2025)
                const CITIES = [
                    { id: "tana", name: "Antananarivo" },
                    { id: "diego", name: "Diego-Suarez" },
                    { id: "mahajanga", name: "Mahajanga" },
                    { id: "tamatave", name: "Toamasina" },
                    { id: "fianar", name: "Fianarantsoa" },
                    { id: "toliara", name: "Toliara" },
                    { id: "antsirabe", name: "Antsirabe" },
                    { id: "morondava", name: "Morondava" },
                    { id: "ambatondrazaka", name: "Ambatondrazaka" },
                    { id: "farafangana", name: "Farafangana" },
                    { id: "manakara", name: "Manakara" },
                    { id: "mananjary", name: "Mananjary" },
                    { id: "ambositra", name: "Ambositra" },
                    { id: "ambatolampy", name: "Ambatolampy" },
                    { id: "antanifotsy", name: "Antanifotsy" },
                    { id: "ambohimandroso", name: "Ambohimandroso" }
                ];

                // Populate Selects
                const createOptions = () => CITIES.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                document.getElementById('taxiFrom').innerHTML = createOptions();
                document.getElementById('taxiTo').innerHTML = createOptions();
                document.getElementById('taxiTo').value = 'diego'; // Default target



                const ROUTES = {
                    // AXE NORD (Majunga / Diego)
                    "tana-mahajanga": {
                        duration: "12h",
                        companies: ["cotisse", "soatrans"],
                        tiers: [
                            { name: "Lite", price: 40000 },
                            { name: "Premium", price: 60000 },
                            { name: "VIP", price: 93000 }
                        ]
                    },
                    "tana-diego": {
                        duration: "24h",
                        companies: ["cotisse"],
                        tiers: [
                            { name: "Brousse Std", price: 100000 },
                            { name: "VIP/Premium", price: 120000 }
                        ]
                    },

                    // AXE EST (Tamatave)
                    "tana-tamatave": {
                        duration: "7h",
                        companies: ["cotisse", "soatrans"],
                        tiers: [
                            { name: "Lite", price: 25000 },
                            { name: "Premium", price: 45000 },
                            { name: "VIP", price: 65000 }
                        ]
                    },
                    "tana-morondava": {
                        duration: "14h",
                        companies: ["cotisse", "soatrans"],
                        tiers: [
                            { name: "Premium", price: 75000 },
                            { name: "VIP", price: 110000 }
                        ]
                    },

                    // AXE SUD (Fianar / Tulear)
                    "tana-antsirabe": {
                        duration: "3h30",
                        companies: ["cotisse", "soatrans"],
                        tiers: [
                            { name: "Lite", price: 15000 },
                            { name: "Premium", price: 25000 }
                        ]
                    },
                    "tana-ambositra": {
                        duration: "6h",
                        companies: ["soatrans"],
                        tiers: [{ name: "Standard", price: 35000 }]
                    },
                    "tana-fianar": {
                        duration: "9h",
                        companies: ["cotisse", "soatrans"],
                        tiers: [
                            { name: "Lite", price: 30000 },
                            { name: "Premium", price: 45000 },
                            { name: "VIP", price: 60000 }
                        ]
                    },
                    "tana-toliara": {
                        duration: "22h",
                        companies: ["cotisse", "soatrans"],
                        tiers: [
                            { name: "Premium", price: 100000 },
                            { name: "VIP", price: 140000 }
                        ]
                    },

                    // EST / SUD-EST
                    "tana-manakara": { duration: "16h", companies: ["soatrans"], tiers: [{ name: "Standard", price: 60000 }] },
                    "tana-farafangana": { duration: "20h", companies: ["soatrans"], tiers: [{ name: "Standard", price: 70000 }] },

                    // Default Fallback
                    "default": { duration: "--", tiers: [] }
                };

                // ONLY COTISSE & SOA TRANS
                const COMPANIES = {
                    "cotisse": { name: "Cotisse Transport", tel: "+261 32 11 027 10", web: "http://www.cotisse-transport.com", premium: true },
                    "soatrans": { name: "Soa Trans Plus", tel: "+261 32 23 909 00", web: "https://soatransplus.mg/", premium: true }
                };

                const getHumorMessage = (durationStr) => {
                    const h = parseInt(durationStr);
                    if (isNaN(h)) return "";

                    const crazyMessages = [
                        // Survival & Existential
                        "Prépare-toi psychologiquement... et physiquement 🍑💥",
                        "Tu auras le temps d'écrire tes mémoires (Tome 1, 2 et le préquel) ✍️",
                        "C'est plus un trajet, c'est une vie parallèle 🌌",
                        "Courage, la légende raconte que certains sont arrivés vivants 😂",
                        "Ton siège est désormais ton domicile fiscal 🛋️",
                        "Astuce : Deviens ami avec ton voisin, vous allez vieillir ensemble 👴",
                        "N'oublie pas de dire au revoir à ta famille, on ne sait jamais 👋",
                        "Tu vas connaître chaque nid de poule par son prénom 🕳️",
                        "Le chauffeur a prévu des pauses... en 2026 📅",
                        "Si tu dors tout le long, c'est comme si ça durait 5 minutes (non) 😴"
                    ];

                    const mediumMessages = [
                        // Practical & Fun
                        "Le moment idéal pour repenser toute ton existence 🤔",
                        "Tu as pris ta playlist 'Survie' ? Parce que c'est le moment 🎧",
                        "C'est l'aventure avec un grand A (et beaucoup de virages) 🚐",
                        "Prévois des snacks. Beaucoup. Vraiment beaucoup 🥪",
                        "Une bonne sieste, deux pauses pipi et t'es arrivé (presque) 🚽",
                        "Profites-en pour finir cette série que tu as commencée il y a 3 ans 📱",
                        "Regarde par la fenêtre, c'est mieux que Netflix 🌳",
                        "Le Wi-Fi du bus est aussi réel que les licornes 🦄",
                        "L'important ce n'est pas la destination, c'est l'état de ton dos à l'arrivée 🦴"
                    ];

                    const shortMessages = [
                        // Speed & Easy
                        "Même pas le temps de finir ton podcast ! ⚡",
                        "Vitesse lumière activée (ou presque) 🚀",
                        "Hop, à peine parti, déjà arrivé ! (Si le chauffeur est motivé) 🏁",
                        "C'est juste à côté... à l'échelle de Madagascar 🇲🇬",
                        "Le temps de cligner des yeux et tu y es 👀",
                        "Pas la peine de sortir l'oreiller, on arrive bientôt 🚫🛌"
                    ];

                    if (h > 15) return crazyMessages[Math.floor(Math.random() * crazyMessages.length)];
                    if (h >= 5) return mediumMessages[Math.floor(Math.random() * mediumMessages.length)];
                    return shortMessages[Math.floor(Math.random() * shortMessages.length)];
                };

                btnCalcTaxi.addEventListener('click', () => {
                    const from = document.getElementById('taxiFrom').value;
                    const to = document.getElementById('taxiTo').value;
                    const resultDiv = document.getElementById('taxiResult');
                    const companiesDiv = document.getElementById('companiesSection');
                    const companiesList = document.getElementById('companiesList');

                    if (from === to) {
                        alert("Veuillez choisir deux villes différentes.");
                        return;
                    }

                    // Try both directions
                    let routeKey = `${from}-${to}`;
                    let route = ROUTES[routeKey];
                    if (!route) {
                        routeKey = `${to}-${from}`;
                        route = ROUTES[routeKey];
                    }
                    if (!route && (from === 'tana' || to === 'tana')) {
                        route = null;
                    }

                    if (route) {
                        const priceHtml = route.tiers.map(t =>
                            `<div class="tier-row">
                                <span class="tier-name">${t.name}</span>
                                <span class="tier-price">${t.price.toLocaleString('fr-FR')} Ar</span>
                             </div>`
                        ).join('');

                        document.getElementById('resDuration').textContent = route.duration;
                        document.getElementById('resPriceContainer').innerHTML = priceHtml;

                        // HUMOR INJECTION (FRAMED & PREMIUM)
                        const humorMsg = getHumorMessage(route.duration);
                        document.querySelector('.result-note').innerHTML = `
                            <div class="humor-frame">
                                <span class="humor-icon" style="font-size:1.4rem;">💡</span>
                                <div class="humor-text">"${humorMsg}"</div>
                            </div>
                            <div class="result-disclaimer">⚠️ Tarifs indicatifs (Lite / Premium / VIP)</div>
                            
                            <style>
                                .humor-frame {
                                    background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
                                    border-left: 6px solid var(--laterite);
                                    padding: 24px 28px; /* Increased padding for breathing room */
                                    margin-bottom: 24px;
                                    border-radius: 0 16px 16px 0;
                                    display: flex;
                                    align-items: center;
                                    gap: 20px;
                                    text-align: left;
                                    box-shadow: 0 8px 20px rgba(0,0,0,0.06);
                                    transition: transform 0.2s ease, box-shadow 0.2s ease;
                                }
                                .humor-frame:hover {
                                    transform: translateX(4px) translateY(-2px);
                                    box-shadow: 0 12px 24px rgba(0,0,0,0.1);
                                }
                                .humor-icon {
                                    font-size: 2.2rem; /* Larger icon */
                                    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));
                                    animation: floatIcon 3s ease-in-out infinite;
                                }
                                @keyframes floatIcon {
                                    0% { transform: translateY(0px); }
                                    50% { transform: translateY(-4px); }
                                    100% { transform: translateY(0px); }
                                }
                                .humor-text {
                                    font-family: var(--font-display);
                                    font-weight: 500; 
                                    color: #4a4a4a; 
                                    font-style: italic;
                                    font-size: 1.1rem; /* Slightly larger text */
                                    line-height: 1.6;
                                }
                                .result-disclaimer {
                                    font-size: 0.8rem;
                                    opacity: 0.6;
                                    text-transform: uppercase;
                                    letter-spacing: 1px;
                                    margin-top: 12px;
                                    font-weight: 500;
                                }
                                /* Dark Mode Adjustment */
                                body.dark-mode .humor-frame {
                                    background: linear-gradient(135deg, #1e1e1e, #2a2a2a);
                                    border-left-color: #ff6b6b;
                                    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
                                }
                                body.dark-mode .humor-text {
                                    color: #ececec;
                                    text-shadow: 0 2px 4px rgba(0,0,0,0.6);
                                }
                            </style>
                        `;

                        resultDiv.classList.remove('hidden');

                        // Show Companies (Filtered)
                        if (route.companies && route.companies.length > 0) {
                            companiesList.innerHTML = route.companies.map(cId => {
                                const comp = COMPANIES[cId];
                                if (!comp) return '';
                                return `
                                <div class="company-card">
                                    <div class="company-info">
                                        <strong>${comp.name}</strong>
                                        <div class="company-badges">
                                            ${comp.premium ? '<span class="company-badge premium">Recommandé</span>' : ''}
                                        </div>
                                    </div>
                                    <div class="company-actions">
                                        <a href="tel:${comp.tel.replace(/\s/g, '')}" class="btn-icon-small" title="Appeler">📞</a>
                                        ${comp.web ? `<a href="${comp.web}" target="_blank" class="btn-icon-small" title="Site Web">🌐</a>` : ''}
                                    </div>
                                </div>`;
                            }).join('');
                            companiesDiv.classList.remove('hidden');
                            setTimeout(() => resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
                        } else {
                            companiesDiv.classList.add('hidden');
                        }
                    } else {
                        resultDiv.classList.add('hidden');
                        companiesDiv.classList.add('hidden');
                        alert("Trajet non listé ou avec correspondance (ex: via Tana).");
                    }
                });
            }
        }

        // ============================================
        // PWA
        // ============================================

        function initInstallPrompt() {
            const installPrompt = document.getElementById('installPrompt');
            const installBtn = document.getElementById('installBtn');
            const installClose = document.getElementById('installClose');

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installPrompt.classList.add('active');
            });

            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;

                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;

                if (outcome === 'accepted') {
                    installPrompt.classList.remove('active');
                }

                deferredPrompt = null;
            });

            installClose.addEventListener('click', () => {
                installPrompt.classList.remove('active');
            });
        }

        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.error('Service Worker error:', err));
            }
        }


        /* ============================================
           ITINERAIRES LOGIC
           ============================================ */

        function initItinerariesPage() {
            const container = document.getElementById('itineraires-list');
            if (!container) return;

            // Wait for data if not ready (though initData promise should handle it, window.ITINERAIRES_DATA might be set)
            const circuits = window.ITINERAIRES_DATA ? Object.values(window.ITINERAIRES_DATA) : [];

            if (circuits.length === 0) {
                container.innerHTML = '<p class="text-center" style="grid-column:1/-1;">Chargement des circuits...</p>';
                return;
            }

            let html = '';
            circuits.forEach((circuit, index) => {
                html += `
                    <div class="lieu-card fade-in-up hover-lift" onclick="showItineraryDetail('${circuit.id}')" style="cursor:pointer; animation-delay: ${index * 0.1}s;">
                         <div class="lieu-image" style="${circuit.image ? `background-image: url('${circuit.image}'); background-size: cover; background-position: center;` : `background: linear-gradient(to bottom right, var(--laterite), var(--foret)); display:flex; align-items:center; justify-content:center; color:white; font-size:3rem;`}">
                            ${!circuit.image ? '<i class="fas fa-route"></i>' : ''}
                         </div>
                         <div class="lieu-content">
                            <h3 class="lieu-title">${circuit.nom}</h3>
                            <div class="lieu-meta">
                                <span class="badge-type">${circuit.duree}</span>
                                <span class="lieu-prix">${circuit.budget}</span>
                            </div>
                            <p class="lieu-desc">${circuit.description}</p>
                            <button class="btn-details">Voir le programme</button>
                         </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        window.showItineraryDetail = function (id) {
            const list = document.getElementById('itineraires-list');
            const detail = document.getElementById('itineraire-detail');
            const content = document.getElementById('itineraire-content');

            const circuits = window.ITINERAIRES_DATA || {};
            let circuit = null;

            Object.values(circuits).forEach(c => {
                if (c.id === id) circuit = c;
            });

            if (!circuit) return;

            list.style.display = 'none';
            detail.style.display = 'block';

            // Helper to switch budgets
            window.switchCircuitBudget = function (level) {
                document.querySelectorAll('.budget-option').forEach(el => el.classList.remove('active'));
                const btn = document.getElementById(`budget-btn-${level}`);
                if (btn) btn.classList.add('active');

                const data = circuit.budgets[level];
                const priceDisplay = document.getElementById('budget-price-display');
                const descDisplay = document.getElementById('budget-desc-display');
                const incDisplay = document.getElementById('budget-inclusions');

                if (priceDisplay && data) priceDisplay.textContent = data.price;
                if (descDisplay && data) descDisplay.textContent = data.desc;

                if (incDisplay && data) {
                    const inclusionsHtml = data.inclus.map(item => `<li><i class="fas fa-check" style="color:var(--success);"></i> ${item}</li>`).join('');
                    incDisplay.innerHTML = inclusionsHtml;
                }
            };

            // --- RENDER CONTENT ---
            let html = `
                <div class="premium-banner-tout city-header" style="background: linear-gradient(135deg, var(--lagon), #047857);">
                    <div class="banner-content">
                        <h2 class="city-title">${circuit.nom}</h2>
                        <p class="city-desc">${circuit.description}</p>
                    </div>
                </div>

                <div style="padding: 20px;">
                    <!-- INFO RAPIDE -->
                    <div style="display:flex; gap:15px; margin-bottom:20px; flex-wrap:wrap;">
                        <span class="meta-tag"><i class="far fa-clock"></i> ${circuit.duree}</span>
                        <span class="meta-tag"><i class="fas fa-shield-alt"></i> Sécurité: ${circuit.infos.securite_level}</span>
                        <span class="meta-tag"><i class="fas fa-sun"></i> ${circuit.logistique.saison_ideale}</span>
                    </div>
                    
                    <!-- GROK AVIS -->
                    <div class="logistique-container" style="margin-top:0;">
                        <div class="logistique-header" onclick="this.nextElementSibling.classList.toggle('active'); this.querySelector('.fa-chevron-down').classList.toggle('fa-chevron-up');">
                            <h3><i class="fas fa-robot"></i> L'avis de l'Expert</h3>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="logistique-content active">
                             <p class="logistique-text">"${circuit.infos.description_fun}"</p>
                             <div style="margin-top:15px; border-top:1px dashed rgba(0,0,0,0.1); padding-top:10px;">
                                 <div style="margin-bottom:6px;"><strong><i class="fas fa-road"></i> Route:</strong> ${circuit.logistique.route_etat}</div>
                                 <div><strong><i class="fas fa-car-side"></i> Véhicule:</strong> ${circuit.logistique.vehicule_conseil}</div>
                             </div>
                        </div>
                    </div>

                    <!-- BUDGET SELECTOR -->
                    <h3 style="margin-top:30px; margin-bottom:15px; font-family:var(--font-display);">Options de Voyage</h3>
                    <div class="budget-selector">
                        <div id="budget-btn-eco" class="budget-option" onclick="switchCircuitBudget('eco')">
                            <span class="budget-label">Eco / Backpacker</span>
                        </div>
                        <div id="budget-btn-standard" class="budget-option active" onclick="switchCircuitBudget('standard')">
                            <span class="budget-label">Confort Standard</span>
                        </div>
                        <div id="budget-btn-premium" class="budget-option" onclick="switchCircuitBudget('premium')">
                            <span class="budget-label">Luxe Premium</span>
                        </div>
                    </div>

                    <div style="background:var(--bg-secondary); padding:20px; border-radius:12px; border:1px solid var(--border-color); box-shadow:0 4px 6px rgba(0,0,0,0.02);">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <span id="budget-price-display" class="budget-price" style="font-size:2rem; color:var(--laterite); font-weight:800;">${circuit.budgets.standard.price}</span>
                            <span style="font-size:0.9rem; color:var(--text-secondary);">/ personne (base 2)</span>
                        </div>
                        <p id="budget-desc-display" style="margin-bottom:15px; color:var(--text-primary); font-size:1.05rem;">${circuit.budgets.standard.desc}</p>
                        <ul id="budget-inclusions" style="list-style:none; padding:0; display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:0.9rem;">
                            ${circuit.budgets.standard.inclus.map(item => `<li><i class="fas fa-check" style="color:var(--success);"></i> ${item}</li>`).join('')}
                        </ul>
                    </div>

                    <!-- TIMELINE -->
                    <h3 style="margin-top:40px; margin-bottom:20px; font-family:var(--font-display);">Programme Détaillé</h3>
                    <div class="timeline-container">
            `;

            // --- TIMELINE STEPS ---
            if (circuit.etapes) {
                circuit.etapes.forEach(step => {
                    // INFO TRANSPORT
                    let transportIcon = 'fa-car';
                    if (step.transport && step.transport.mode) {
                        const mode = step.transport.mode.toLowerCase();
                        if (mode.includes('bateau') || mode.includes('coque')) transportIcon = 'fa-ship';
                        if (mode.includes('marche') || mode.includes('pied')) transportIcon = 'fa-hiking';
                        if (mode.includes('avion')) transportIcon = 'fa-plane';
                    }

                    html += `
                        <div class="timeline-step">
                            <div class="timeline-marker"></div>
                            
                            <!-- Header Day Title -->
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <div>
                                    <span class="timeline-day">Jour ${step.jour}</span>
                                    <h4 class="timeline-title">${step.titre}</h4>
                                </div>
                                ${step.transport ? `
                                    <div class="transport-badge" title="${step.transport.info}">
                                        <i class="fas ${transportIcon}"></i> <span>${step.transport.duree}</span>
                                    </div>
                                ` : ''}
                            </div>

                            <div class="timeline-content">${step.description}</div>
                            
                            <!-- BLOC ASTUCE (New) -->
                             ${step.astuce ? `
                                <div class="astuce-box pulse-soft" style="margin-bottom:15px;">
                                    <div class="astuce-icon"><i class="fas fa-lightbulb"></i></div>
                                    <div class="astuce-content">
                                        <strong>Le Tips de l'Expert :</strong> ${step.astuce}
                                    </div>
                                </div>
                            ` : ''}

                            ${step.conseil ? `<p style="font-size:0.9rem; color:var(--text-secondary); margin-bottom:10px;"><i class="fas fa-info-circle"></i> ${step.conseil}</p>` : ''}
                    `;

                    // Linked Locations
                    if (step.lieux_ids && step.lieux_ids.length > 0) {
                        html += `<div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;">`;
                        step.lieux_ids.forEach(lid => {
                            const lieu = window.LIEUX_DATA.find(l => l.id === lid);
                            if (lieu) {
                                html += `
                                    <button onclick="openModal(${lieu.id})" class="timeline-link">
                                        <i class="fas fa-map-marker-alt"></i> ${lieu.nom}
                                    </button>
                                `;
                            }
                        });
                        html += `</div>`;
                    }

                    html += `</div>`;
                });
            }

            html += `</div></div>`; // End timeline container & wrapper

            content.innerHTML = html;

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.backToItineraries = function () {
            document.getElementById('itineraires-list').style.display = 'grid';
            document.getElementById('itineraire-detail').style.display = 'none';
            // Scroll back to list position if possible, or top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

    </script>
    <script src="js/app-data.js"></script>
</body>

</html>
```